export class SelectionManager {
    constructor() {
        this.selectionsList = new Array();
    }
    dispose() {
        this.selectionsList.length = 0;
        delete this.selectionsList;
        delete this.items;
    }
    get itemsSource() {
        return this.items;
    }
    set itemsSource(value) {
        this.items = value;
    }
    processSelection(item, selected) {
        item.selected = selected;
        if (item.onSelectionChanged !== undefined) {
            item.onSelectionChanged(selected);
        }
        if (selected === true && item.onSelected !== undefined) {
            item.onSelected();
        }
        if (selected === false && item.onDeselected !== undefined) {
            item.onDeselected();
        }
    }
    deselectItem(selectionTuple, recursive = false) {
        const index = this.selectionsList.findIndex(selectedItem => (selectedItem.item === selectionTuple.item));
        if (index !== -1) {
            this.selectionsList.splice(index, 1);
        }
        this.processSelection(selectionTuple.item, false);
        if (this.canRecurse(recursive, selectionTuple.item)) {
            /* tslint:disable:no-any */
            (selectionTuple.item).selectionManager.deselectAll(true);
        }
        this.lastProcessedIndex = selectionTuple.index;
    }
    selectItem(selectionTuple, savePrevious = false, recursive = false) {
        if (savePrevious) {
            const index = this.selectionsList.findIndex(selectedItem => (selectedItem.item === selectionTuple.item));
            if (index !== -1) {
                this.processSelection(selectionTuple.item, false);
                this.selectionsList.splice(index, 1);
            }
            this.selectionsList.push(selectionTuple);
            this.processSelection(selectionTuple.item, true);
        }
        else {
            const list = this.selectionsList.splice(0, this.selectionsList.length);
            list.forEach(selectedItem => { this.processSelection(selectedItem.item, false); });
            this.selectionsList.push(selectionTuple);
            this.processSelection(selectionTuple.item, true);
        }
        if (this.canRecurse(recursive, selectionTuple.item)) {
            /* tslint:disable:no-any */
            (selectionTuple.item).selectionManager.selectAll(true);
        }
        this.lastProcessedIndex = selectionTuple.index;
    }
    canRecurse(recursive, /* tslint:disable:no-any */ item /* tslint:enable:no-any */) {
        if (recursive && item.selectionManager && item.selectionManager instanceof SelectionManager) {
            return true;
        }
        return false;
    }
    getSelectionTuple(index) {
        return {
            index: index,
            item: this.itemsSource[index]
        };
    }
    deselectAll(recursive = false) {
        const list = this.selectionsList.splice(0, this.selectionsList.length);
        for (let i = 0; i < list.length; i++) {
            const item = list[i].item;
            this.processSelection(item, false);
            if (this.canRecurse(recursive, item)) {
                /* tslint:disable:no-any */
                (item).selectionManager.deselectAll(true);
            }
        }
        this.lastProcessedIndex = null;
    }
    selectAll(recursive = false) {
        this.selectRange(0, this.itemsSource.length - 1, recursive);
    }
    selectRange(fromIndex, toIndex, recursive = false) {
        if (toIndex < 0 || this.itemsSource.length <= toIndex || fromIndex < 0 || this.itemsSource.length <= fromIndex) {
            return;
        }
        const startIndex = Math.min(fromIndex, toIndex);
        const endIndex = Math.max(fromIndex, toIndex);
        this.deselectAll();
        const tempData = new Array();
        for (let i = startIndex; i <= endIndex; i++) {
            const tuple = this.getSelectionTuple(i);
            tempData.push(tuple);
            this.processSelection(tuple.item, true);
            if (this.canRecurse(recursive, tuple.item)) {
                /* tslint:disable:no-any */
                (tuple.item).selectionManager.selectAll(true);
            }
        }
        this.selectionsList.splice(0, this.selectionsList.length, ...tempData);
        this.lastProcessedIndex = endIndex;
    }
    hasSelections() {
        return this.selectionsList.length !== 0;
    }
    isIndexSelected(index) {
        if (index >= 0 && this.itemsSource.length > index) {
            return this.itemsSource[index].selected;
        }
        return false;
    }
    getItemIndex(item) {
        return this.itemsSource.findIndex(value => value === item);
    }
    getMinSelectedIndex() {
        let minIndex = null;
        this.selectionsList.forEach(item => {
            minIndex = (minIndex === null || item.index < minIndex) ? item.index : minIndex;
        });
        return minIndex;
    }
    getMaxSelectedIndex() {
        let maxIndex = null;
        this.selectionsList.forEach(item => {
            maxIndex = (maxIndex === null || item.index > maxIndex) ? item.index : maxIndex;
        });
        return maxIndex;
    }
    selectFirst() {
        if (this.itemsSource.length > 0) {
            this.selectItem(this.getSelectionTuple(0));
        }
    }
    selectLast() {
        if (this.itemsSource.length > 0) {
            this.selectItem(this.getSelectionTuple(this.itemsSource.length - 1));
        }
    }
    selectIndex(index, savePrevious = false, recursive = false) {
        if (index >= 0 && this.itemsSource.length > index) {
            this.selectItem(this.getSelectionTuple(index), savePrevious, recursive);
        }
    }
    deselectIndex(index, recursive = false) {
        if (index >= 0 && this.itemsSource.length > index) {
            this.deselectItem(this.getSelectionTuple(index), recursive);
        }
    }
    toggleSelection(index, savePrevious = false, recursive = false) {
        if (index < 0 || this.itemsSource.length <= index) {
            return;
        }
        const tuple = this.getSelectionTuple(index);
        if (this.isIndexSelected(index)) {
            if (this.selectionsList.length === 1 || (this.selectionsList.length > 1 && savePrevious)) {
                this.deselectItem(tuple, recursive);
            }
            else {
                this.selectItem(tuple, savePrevious, recursive);
            }
            return;
        }
        this.selectItem(tuple, savePrevious, recursive);
    }
    getSelections(recursive = false) {
        if (recursive) {
            let result = [];
            for (let i = 0; i < this.selectionsList.length; i++) {
                const item = this.selectionsList[i].item;
                result.push(item);
                if (this.canRecurse(recursive, item)) {
                    /* tslint:disable:no-any */
                    result = result.concat((item).selectionManager.getSelections(true));
                }
            }
        }
        return this.selectionsList.map((selectable) => selectable.item);
    }
}

//# sourceMappingURL=data:application/json;base64,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SSxDQUFDLGNBQWMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztnQkFDbEQsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7Z0JBQ3pDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ2xCLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDbkMsMkJBQTJCO29CQUMzQixNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFFLElBQVksQ0FBQyxDQUFDLGdCQUFnQixDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO2dCQUVqRixDQUFDO1lBQ0wsQ0FBQztRQUNMLENBQUM7UUFDRCxNQUFNLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxVQUFVLEtBQUssVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3BFLENBQUM7QUFDTCxDQUFDO0FBQUEiLCJmaWxlIjoic2VsZWN0aW9uTWFuYWdlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7SVNlbGVjdGFibGV9IGZyb20gJy4vY29udHJhY3RzL0lTZWxlY3RhYmxlJztcclxuaW1wb3J0IHtJU2VsZWN0aW9uTWFuYWdlcn0gZnJvbSAnLi9jb250cmFjdHMvSVNlbGVjdGlvbk1hbmFnZXInO1xyXG5pbXBvcnQge0lTZWxlY3Rpb25UdXBsZX0gZnJvbSAnLi9jb250cmFjdHMvSVNlbGVjdGlvblR1cGxlJztcclxuZXhwb3J0IGNsYXNzIFNlbGVjdGlvbk1hbmFnZXIgaW1wbGVtZW50cyBJU2VsZWN0aW9uTWFuYWdlciB7XHJcbiAgICBwcml2YXRlIHNlbGVjdGlvbnNMaXN0ID0gbmV3IEFycmF5PElTZWxlY3Rpb25UdXBsZT4oKTtcclxuICAgIHByaXZhdGUgaXRlbXM6IEFycmF5PElTZWxlY3RhYmxlPjtcclxuICAgIHByaXZhdGUgaXRlbXNQcm9wZXJ0eU5hbWU6IHN0cmluZztcclxuICAgIGRpc3Bvc2UoKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5zZWxlY3Rpb25zTGlzdC5sZW5ndGggPSAwO1xyXG4gICAgICAgIGRlbGV0ZSB0aGlzLnNlbGVjdGlvbnNMaXN0O1xyXG4gICAgICAgIGRlbGV0ZSB0aGlzLml0ZW1zO1xyXG4gICAgfVxyXG5cclxuICAgIGxhc3RQcm9jZXNzZWRJbmRleDogbnVtYmVyO1xyXG4gICAgZ2V0IGl0ZW1zU291cmNlKCk6IEFycmF5PElTZWxlY3RhYmxlPiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuaXRlbXM7XHJcbiAgICB9XHJcbiAgICBzZXQgaXRlbXNTb3VyY2UodmFsdWU6IEFycmF5PElTZWxlY3RhYmxlPikge1xyXG4gICAgICAgIHRoaXMuaXRlbXMgPSB2YWx1ZTtcclxuICAgIH1cclxuICAgIHByaXZhdGUgcHJvY2Vzc1NlbGVjdGlvbihpdGVtOiBJU2VsZWN0YWJsZSwgc2VsZWN0ZWQ6IGJvb2xlYW4pOiB2b2lkIHtcclxuICAgICAgICBpdGVtLnNlbGVjdGVkID0gc2VsZWN0ZWQ7XHJcbiAgICAgICAgaWYgKGl0ZW0ub25TZWxlY3Rpb25DaGFuZ2VkICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgaXRlbS5vblNlbGVjdGlvbkNoYW5nZWQoc2VsZWN0ZWQpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoc2VsZWN0ZWQgPT09IHRydWUgJiYgaXRlbS5vblNlbGVjdGVkICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgaXRlbS5vblNlbGVjdGVkKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChzZWxlY3RlZCA9PT0gZmFsc2UgJiYgaXRlbS5vbkRlc2VsZWN0ZWQgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICBpdGVtLm9uRGVzZWxlY3RlZCgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHByaXZhdGUgZGVzZWxlY3RJdGVtKHNlbGVjdGlvblR1cGxlOiBJU2VsZWN0aW9uVHVwbGUsIHJlY3Vyc2l2ZTogYm9vbGVhbiA9IGZhbHNlKTogdm9pZCB7XHJcbiAgICAgICAgY29uc3QgaW5kZXggPSB0aGlzLnNlbGVjdGlvbnNMaXN0LmZpbmRJbmRleChzZWxlY3RlZEl0ZW0gPT4gKHNlbGVjdGVkSXRlbS5pdGVtID09PSBzZWxlY3Rpb25UdXBsZS5pdGVtKSk7XHJcbiAgICAgICAgaWYgKGluZGV4ICE9PSAtMSkge1xyXG4gICAgICAgICAgICB0aGlzLnNlbGVjdGlvbnNMaXN0LnNwbGljZShpbmRleCwgMSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMucHJvY2Vzc1NlbGVjdGlvbihzZWxlY3Rpb25UdXBsZS5pdGVtLCBmYWxzZSk7XHJcbiAgICAgICAgaWYgKHRoaXMuY2FuUmVjdXJzZShyZWN1cnNpdmUsIHNlbGVjdGlvblR1cGxlLml0ZW0pKSB7XHJcbiAgICAgICAgICAgIC8qIHRzbGludDpkaXNhYmxlOm5vLWFueSAqL1xyXG4gICAgICAgICAgICAoKHNlbGVjdGlvblR1cGxlLml0ZW0gYXMgYW55KSkuc2VsZWN0aW9uTWFuYWdlci5kZXNlbGVjdEFsbCh0cnVlKTtcclxuICAgICAgICAgICAgLyogdHNsaW50OmVuYWJsZTpuby1hbnkgKi9cclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5sYXN0UHJvY2Vzc2VkSW5kZXggPSBzZWxlY3Rpb25UdXBsZS5pbmRleDtcclxuICAgIH1cclxuICAgIHByaXZhdGUgc2VsZWN0SXRlbShzZWxlY3Rpb25UdXBsZTogSVNlbGVjdGlvblR1cGxlLCBzYXZlUHJldmlvdXM6IGJvb2xlYW4gPSBmYWxzZSwgcmVjdXJzaXZlOiBib29sZWFuID0gZmFsc2UpOiB2b2lkIHtcclxuICAgICAgICBpZiAoc2F2ZVByZXZpb3VzKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy5zZWxlY3Rpb25zTGlzdC5maW5kSW5kZXgoc2VsZWN0ZWRJdGVtID0+IChzZWxlY3RlZEl0ZW0uaXRlbSA9PT0gc2VsZWN0aW9uVHVwbGUuaXRlbSkpO1xyXG4gICAgICAgICAgICBpZiAoaW5kZXggIT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnByb2Nlc3NTZWxlY3Rpb24oc2VsZWN0aW9uVHVwbGUuaXRlbSwgZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zZWxlY3Rpb25zTGlzdC5zcGxpY2UoaW5kZXgsIDEpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMuc2VsZWN0aW9uc0xpc3QucHVzaChzZWxlY3Rpb25UdXBsZSk7XHJcbiAgICAgICAgICAgIHRoaXMucHJvY2Vzc1NlbGVjdGlvbihzZWxlY3Rpb25UdXBsZS5pdGVtLCB0cnVlKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBjb25zdCBsaXN0ID0gdGhpcy5zZWxlY3Rpb25zTGlzdC5zcGxpY2UoMCwgdGhpcy5zZWxlY3Rpb25zTGlzdC5sZW5ndGgpO1xyXG4gICAgICAgICAgICBsaXN0LmZvckVhY2goc2VsZWN0ZWRJdGVtID0+IHsgdGhpcy5wcm9jZXNzU2VsZWN0aW9uKHNlbGVjdGVkSXRlbS5pdGVtLCBmYWxzZSk7IH0pO1xyXG4gICAgICAgICAgICB0aGlzLnNlbGVjdGlvbnNMaXN0LnB1c2goc2VsZWN0aW9uVHVwbGUpO1xyXG4gICAgICAgICAgICB0aGlzLnByb2Nlc3NTZWxlY3Rpb24oc2VsZWN0aW9uVHVwbGUuaXRlbSwgdHJ1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0aGlzLmNhblJlY3Vyc2UocmVjdXJzaXZlLCBzZWxlY3Rpb25UdXBsZS5pdGVtKSkge1xyXG4gICAgICAgICAgICAvKiB0c2xpbnQ6ZGlzYWJsZTpuby1hbnkgKi9cclxuICAgICAgICAgICAgKChzZWxlY3Rpb25UdXBsZS5pdGVtIGFzIGFueSkpLnNlbGVjdGlvbk1hbmFnZXIuc2VsZWN0QWxsKHRydWUpO1xyXG4gICAgICAgICAgICAvKiB0c2xpbnQ6ZW5hYmxlOm5vLWFueSAqL1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmxhc3RQcm9jZXNzZWRJbmRleCA9IHNlbGVjdGlvblR1cGxlLmluZGV4O1xyXG4gICAgfVxyXG4gICAgcHJpdmF0ZSBjYW5SZWN1cnNlKHJlY3Vyc2l2ZTogYm9vbGVhbiwgLyogdHNsaW50OmRpc2FibGU6bm8tYW55ICovaXRlbTogYW55LyogdHNsaW50OmVuYWJsZTpuby1hbnkgKi8pOiBib29sZWFuIHtcclxuICAgICAgICBpZiAocmVjdXJzaXZlICYmIGl0ZW0uc2VsZWN0aW9uTWFuYWdlciAmJiBpdGVtLnNlbGVjdGlvbk1hbmFnZXIgaW5zdGFuY2VvZiBTZWxlY3Rpb25NYW5hZ2VyKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcbiAgICBwcml2YXRlIGdldFNlbGVjdGlvblR1cGxlKGluZGV4OiBudW1iZXIpOiBJU2VsZWN0aW9uVHVwbGUge1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIGluZGV4OiBpbmRleCxcclxuICAgICAgICAgICAgaXRlbTogdGhpcy5pdGVtc1NvdXJjZVtpbmRleF1cclxuICAgICAgICB9O1xyXG4gICAgfVxyXG4gICAgZGVzZWxlY3RBbGwocmVjdXJzaXZlOiBib29sZWFuID0gZmFsc2UpOiB2b2lkIHtcclxuICAgICAgICBjb25zdCBsaXN0ID0gdGhpcy5zZWxlY3Rpb25zTGlzdC5zcGxpY2UoMCwgdGhpcy5zZWxlY3Rpb25zTGlzdC5sZW5ndGgpO1xyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGlzdC5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICBjb25zdCBpdGVtID0gbGlzdFtpXS5pdGVtO1xyXG4gICAgICAgICAgICB0aGlzLnByb2Nlc3NTZWxlY3Rpb24oaXRlbSwgZmFsc2UpO1xyXG4gICAgICAgICAgICBpZiAodGhpcy5jYW5SZWN1cnNlKHJlY3Vyc2l2ZSwgaXRlbSkpIHtcclxuICAgICAgICAgICAgICAgIC8qIHRzbGludDpkaXNhYmxlOm5vLWFueSAqL1xyXG4gICAgICAgICAgICAgICAgKChpdGVtIGFzIGFueSkpLnNlbGVjdGlvbk1hbmFnZXIuZGVzZWxlY3RBbGwodHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAvKiB0c2xpbnQ6ZW5hYmxlOm5vLWFueSAqL1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMubGFzdFByb2Nlc3NlZEluZGV4ID0gbnVsbDtcclxuICAgIH1cclxuICAgIHNlbGVjdEFsbChyZWN1cnNpdmU6IGJvb2xlYW4gPSBmYWxzZSk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuc2VsZWN0UmFuZ2UoMCwgdGhpcy5pdGVtc1NvdXJjZS5sZW5ndGggLSAxLCByZWN1cnNpdmUpO1xyXG4gICAgfVxyXG4gICAgc2VsZWN0UmFuZ2UoZnJvbUluZGV4OiBudW1iZXIsIHRvSW5kZXg6IG51bWJlciwgcmVjdXJzaXZlOiBib29sZWFuID0gZmFsc2UpOiB2b2lkIHtcclxuICAgICAgICBpZiAodG9JbmRleCA8IDAgfHwgdGhpcy5pdGVtc1NvdXJjZS5sZW5ndGggPD0gdG9JbmRleCB8fCBmcm9tSW5kZXggPCAwIHx8IHRoaXMuaXRlbXNTb3VyY2UubGVuZ3RoIDw9IGZyb21JbmRleCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHN0YXJ0SW5kZXggPSBNYXRoLm1pbihmcm9tSW5kZXgsIHRvSW5kZXgpO1xyXG4gICAgICAgIGNvbnN0IGVuZEluZGV4ID0gTWF0aC5tYXgoZnJvbUluZGV4LCB0b0luZGV4KTtcclxuICAgICAgICB0aGlzLmRlc2VsZWN0QWxsKCk7XHJcbiAgICAgICAgY29uc3QgdGVtcERhdGEgPSBuZXcgQXJyYXk8SVNlbGVjdGlvblR1cGxlPigpO1xyXG4gICAgICAgIGZvciAobGV0IGkgPSBzdGFydEluZGV4OyBpIDw9IGVuZEluZGV4OyBpKyspIHtcclxuICAgICAgICAgICAgY29uc3QgdHVwbGUgPSB0aGlzLmdldFNlbGVjdGlvblR1cGxlKGkpO1xyXG4gICAgICAgICAgICB0ZW1wRGF0YS5wdXNoKHR1cGxlKTtcclxuICAgICAgICAgICAgdGhpcy5wcm9jZXNzU2VsZWN0aW9uKHR1cGxlLml0ZW0sIHRydWUpO1xyXG4gICAgICAgICAgICBpZiAodGhpcy5jYW5SZWN1cnNlKHJlY3Vyc2l2ZSwgdHVwbGUuaXRlbSkpIHtcclxuICAgICAgICAgICAgICAgIC8qIHRzbGludDpkaXNhYmxlOm5vLWFueSAqL1xyXG4gICAgICAgICAgICAgICAgKCh0dXBsZS5pdGVtIGFzIGFueSkpLnNlbGVjdGlvbk1hbmFnZXIuc2VsZWN0QWxsKHRydWUpO1xyXG4gICAgICAgICAgICAgICAgLyogdHNsaW50OmVuYWJsZTpuby1hbnkgKi9cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnNlbGVjdGlvbnNMaXN0LnNwbGljZSgwLCB0aGlzLnNlbGVjdGlvbnNMaXN0Lmxlbmd0aCwgLi4udGVtcERhdGEpO1xyXG4gICAgICAgIHRoaXMubGFzdFByb2Nlc3NlZEluZGV4ID0gZW5kSW5kZXg7XHJcbiAgICB9XHJcblxyXG4gICAgaGFzU2VsZWN0aW9ucygpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5zZWxlY3Rpb25zTGlzdC5sZW5ndGggIT09IDA7XHJcbiAgICB9XHJcbiAgICBpc0luZGV4U2VsZWN0ZWQoaW5kZXg6IG51bWJlcik6IGJvb2xlYW4ge1xyXG4gICAgICAgIGlmIChpbmRleCA+PSAwICYmIHRoaXMuaXRlbXNTb3VyY2UubGVuZ3RoID4gaW5kZXgpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuaXRlbXNTb3VyY2VbaW5kZXhdLnNlbGVjdGVkO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0SXRlbUluZGV4KGl0ZW06IElTZWxlY3RhYmxlKTogbnVtYmVyIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5pdGVtc1NvdXJjZS5maW5kSW5kZXgodmFsdWUgPT4gdmFsdWUgPT09IGl0ZW0pO1xyXG4gICAgfVxyXG4gICAgZ2V0TWluU2VsZWN0ZWRJbmRleCgpOiBudW1iZXIge1xyXG4gICAgICAgIGxldCBtaW5JbmRleCA9IG51bGw7XHJcbiAgICAgICAgdGhpcy5zZWxlY3Rpb25zTGlzdC5mb3JFYWNoKGl0ZW0gPT4ge1xyXG4gICAgICAgICAgICBtaW5JbmRleCA9IChtaW5JbmRleCA9PT0gbnVsbCB8fCBpdGVtLmluZGV4IDwgbWluSW5kZXgpID8gaXRlbS5pbmRleCA6IG1pbkluZGV4O1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJldHVybiBtaW5JbmRleDtcclxuICAgIH1cclxuICAgIGdldE1heFNlbGVjdGVkSW5kZXgoKTogbnVtYmVyIHtcclxuICAgICAgICBsZXQgbWF4SW5kZXggPSBudWxsO1xyXG4gICAgICAgIHRoaXMuc2VsZWN0aW9uc0xpc3QuZm9yRWFjaChpdGVtID0+IHtcclxuICAgICAgICAgICAgbWF4SW5kZXggPSAobWF4SW5kZXggPT09IG51bGwgfHwgaXRlbS5pbmRleCA+IG1heEluZGV4KSA/IGl0ZW0uaW5kZXggOiBtYXhJbmRleDtcclxuICAgICAgICB9KTtcclxuICAgICAgICByZXR1cm4gbWF4SW5kZXg7XHJcbiAgICB9XHJcblxyXG4gICAgc2VsZWN0Rmlyc3QoKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKHRoaXMuaXRlbXNTb3VyY2UubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICB0aGlzLnNlbGVjdEl0ZW0odGhpcy5nZXRTZWxlY3Rpb25UdXBsZSgwKSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgc2VsZWN0TGFzdCgpOiB2b2lkIHtcclxuICAgICAgICBpZiAodGhpcy5pdGVtc1NvdXJjZS5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2VsZWN0SXRlbSh0aGlzLmdldFNlbGVjdGlvblR1cGxlKHRoaXMuaXRlbXNTb3VyY2UubGVuZ3RoIC0gMSkpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBzZWxlY3RJbmRleChpbmRleDogbnVtYmVyLCBzYXZlUHJldmlvdXM6IGJvb2xlYW4gPSBmYWxzZSwgcmVjdXJzaXZlOiBib29sZWFuID0gZmFsc2UpOiB2b2lkIHtcclxuICAgICAgICBpZiAoaW5kZXggPj0gMCAmJiB0aGlzLml0ZW1zU291cmNlLmxlbmd0aCA+IGluZGV4KSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2VsZWN0SXRlbSh0aGlzLmdldFNlbGVjdGlvblR1cGxlKGluZGV4KSwgc2F2ZVByZXZpb3VzLCByZWN1cnNpdmUpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIGRlc2VsZWN0SW5kZXgoaW5kZXg6IG51bWJlciwgcmVjdXJzaXZlOiBib29sZWFuID0gZmFsc2UpOiB2b2lkIHtcclxuICAgICAgICBpZiAoaW5kZXggPj0gMCAmJiB0aGlzLml0ZW1zU291cmNlLmxlbmd0aCA+IGluZGV4KSB7XHJcbiAgICAgICAgICAgIHRoaXMuZGVzZWxlY3RJdGVtKHRoaXMuZ2V0U2VsZWN0aW9uVHVwbGUoaW5kZXgpLCByZWN1cnNpdmUpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHRvZ2dsZVNlbGVjdGlvbihpbmRleDogbnVtYmVyLCBzYXZlUHJldmlvdXM6IGJvb2xlYW4gPSBmYWxzZSwgcmVjdXJzaXZlOiBib29sZWFuID0gZmFsc2UpOiB2b2lkIHtcclxuICAgICAgICBpZiAoaW5kZXggPCAwIHx8IHRoaXMuaXRlbXNTb3VyY2UubGVuZ3RoIDw9IGluZGV4KSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgdHVwbGUgPSB0aGlzLmdldFNlbGVjdGlvblR1cGxlKGluZGV4KTtcclxuICAgICAgICBpZiAodGhpcy5pc0luZGV4U2VsZWN0ZWQoaW5kZXgpKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnNlbGVjdGlvbnNMaXN0Lmxlbmd0aCA9PT0gMSB8fCAodGhpcy5zZWxlY3Rpb25zTGlzdC5sZW5ndGggPiAxICYmIHNhdmVQcmV2aW91cykpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZGVzZWxlY3RJdGVtKHR1cGxlLCByZWN1cnNpdmUpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RJdGVtKHR1cGxlLCBzYXZlUHJldmlvdXMsIHJlY3Vyc2l2ZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnNlbGVjdEl0ZW0odHVwbGUsIHNhdmVQcmV2aW91cywgcmVjdXJzaXZlKTtcclxuICAgIH1cclxuICAgIGdldFNlbGVjdGlvbnMocmVjdXJzaXZlOiBib29sZWFuID0gZmFsc2UpOiBBcnJheTxPYmplY3Q+IHtcclxuICAgICAgICBpZiAocmVjdXJzaXZlKSB7XHJcbiAgICAgICAgICAgIGxldCByZXN1bHQgPSBbXTtcclxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnNlbGVjdGlvbnNMaXN0Lmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBpdGVtID0gdGhpcy5zZWxlY3Rpb25zTGlzdFtpXS5pdGVtO1xyXG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goaXRlbSk7XHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5jYW5SZWN1cnNlKHJlY3Vyc2l2ZSwgaXRlbSkpIHtcclxuICAgICAgICAgICAgICAgICAgICAvKiB0c2xpbnQ6ZGlzYWJsZTpuby1hbnkgKi9cclxuICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSByZXN1bHQuY29uY2F0KCgoaXRlbSBhcyBhbnkpKS5zZWxlY3Rpb25NYW5hZ2VyLmdldFNlbGVjdGlvbnModHJ1ZSkpO1xyXG4gICAgICAgICAgICAgICAgICAgIC8qIHRzbGludDplbmFibGU6bm8tYW55ICovXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuc2VsZWN0aW9uc0xpc3QubWFwKChzZWxlY3RhYmxlKSA9PiBzZWxlY3RhYmxlLml0ZW0pO1xyXG4gICAgfVxyXG59XHJcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
