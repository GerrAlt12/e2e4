export class SelectionManager {
    constructor() {
        this.selectionsList = new Array();
    }
    dispose() {
        this.selectionsList.length = 0;
        delete this.selectionsList;
        delete this.items;
    }
    get itemsSource() {
        return this.items;
    }
    set itemsSource(value) {
        this.items = value;
        this.checkSelection();
    }
    processSelection(item, selected) {
        item.selected = selected;
        if (item.onSelectionChanged !== undefined) {
            item.onSelectionChanged(selected);
        }
        if (selected === true && item.onSelected !== undefined) {
            item.onSelected();
        }
        if (selected === false && item.onDeselected !== undefined) {
            item.onDeselected();
        }
    }
    deselectItem(selectionTuple, recursive = false) {
        const index = this.selectionsList.findIndex(selectedItem => (selectedItem.item === selectionTuple.item));
        if (index !== -1) {
            this.selectionsList.splice(index, 1);
        }
        this.processSelection(selectionTuple.item, false);
        if (this.canRecurse(recursive, selectionTuple.item)) {
            /* tslint:disable:no-any */
            (selectionTuple.item).selectionManager.deselectAll(true);
        }
        this.lastProcessedIndex = selectionTuple.index;
    }
    selectItem(selectionTuple, savePrevious = false, recursive = false) {
        if (savePrevious) {
            const index = this.selectionsList.findIndex(selectedItem => (selectedItem.item === selectionTuple.item));
            if (index !== -1) {
                this.processSelection(selectionTuple.item, false);
                this.selectionsList.splice(index, 1);
            }
            this.selectionsList.push(selectionTuple);
            this.processSelection(selectionTuple.item, true);
        }
        else {
            const list = this.selectionsList.splice(0, this.selectionsList.length);
            list.forEach(selectedItem => { this.processSelection(selectedItem.item, false); });
            this.selectionsList.push(selectionTuple);
            this.processSelection(selectionTuple.item, true);
        }
        if (this.canRecurse(recursive, selectionTuple.item)) {
            /* tslint:disable:no-any */
            (selectionTuple.item).selectionManager.selectAll(true);
        }
        this.lastProcessedIndex = selectionTuple.index;
    }
    canRecurse(recursive, /* tslint:disable:no-any */ item /* tslint:enable:no-any */) {
        if (recursive && item.selectionManager && item.selectionManager instanceof SelectionManager) {
            return true;
        }
        return false;
    }
    getSelectionTuple(index) {
        return {
            index: index,
            item: this.itemsSource[index]
        };
    }
    checkSelection() {
        for (let i = this.selectionsList.length - 1; i >= 0; i--) {
            const tuple = this.selectionsList[i];
            if (this.itemsSource[tuple.index] !== tuple.item) {
                this.deselectItem(tuple);
            }
        }
    }
    deselectAll(recursive = false) {
        const list = this.selectionsList.splice(0, this.selectionsList.length);
        for (let i = 0; i < list.length; i++) {
            const item = list[i].item;
            this.processSelection(item, false);
            if (this.canRecurse(recursive, item)) {
                /* tslint:disable:no-any */
                (item).selectionManager.deselectAll(true);
            }
        }
        this.lastProcessedIndex = null;
    }
    selectAll(recursive = false) {
        this.selectRange(0, this.itemsSource.length - 1, recursive);
    }
    selectRange(fromIndex, toIndex, recursive = false) {
        if (toIndex < 0 || this.itemsSource.length <= toIndex || fromIndex < 0 || this.itemsSource.length <= fromIndex) {
            return;
        }
        const startIndex = Math.min(fromIndex, toIndex);
        const endIndex = Math.max(fromIndex, toIndex);
        this.deselectAll();
        const tempData = new Array();
        for (let i = startIndex; i <= endIndex; i++) {
            const tuple = this.getSelectionTuple(i);
            tempData.push(tuple);
            this.processSelection(tuple.item, true);
            if (this.canRecurse(recursive, tuple.item)) {
                /* tslint:disable:no-any */
                (tuple.item).selectionManager.selectAll(true);
            }
        }
        this.selectionsList.splice(0, this.selectionsList.length, ...tempData);
        this.lastProcessedIndex = endIndex;
    }
    hasSelections() {
        return this.selectionsList.length !== 0;
    }
    isIndexSelected(index) {
        if (index >= 0 && this.itemsSource.length > index) {
            return this.itemsSource[index].selected;
        }
        return false;
    }
    getItemIndex(item) {
        return this.itemsSource.findIndex(value => value === item);
    }
    getMinSelectedIndex() {
        let minIndex = null;
        this.selectionsList.forEach(item => {
            minIndex = (minIndex === null || item.index < minIndex) ? item.index : minIndex;
        });
        return minIndex;
    }
    getMaxSelectedIndex() {
        let maxIndex = null;
        this.selectionsList.forEach(item => {
            maxIndex = (maxIndex === null || item.index > maxIndex) ? item.index : maxIndex;
        });
        return maxIndex;
    }
    selectFirst() {
        if (this.itemsSource.length > 0) {
            this.selectItem(this.getSelectionTuple(0));
        }
    }
    selectLast() {
        if (this.itemsSource.length > 0) {
            this.selectItem(this.getSelectionTuple(this.itemsSource.length - 1));
        }
    }
    selectIndex(index, savePrevious = false, recursive = false) {
        if (index >= 0 && this.itemsSource.length > index) {
            this.selectItem(this.getSelectionTuple(index), savePrevious, recursive);
        }
    }
    deselectIndex(index, recursive = false) {
        if (index >= 0 && this.itemsSource.length > index) {
            this.deselectItem(this.getSelectionTuple(index), recursive);
        }
    }
    toggleSelection(index, savePrevious = false, recursive = false) {
        if (index < 0 || this.itemsSource.length <= index) {
            return;
        }
        const tuple = this.getSelectionTuple(index);
        if (this.isIndexSelected(index)) {
            if (this.selectionsList.length === 1 || (this.selectionsList.length > 1 && savePrevious)) {
                this.deselectItem(tuple, recursive);
            }
            else {
                this.selectItem(tuple, savePrevious, recursive);
            }
            return;
        }
        this.selectItem(tuple, savePrevious, recursive);
    }
    getSelections(recursive = false) {
        if (recursive) {
            let result = [];
            for (let i = 0; i < this.selectionsList.length; i++) {
                const item = this.selectionsList[i].item;
                result.push(item);
                if (this.canRecurse(recursive, item)) {
                    /* tslint:disable:no-any */
                    result = result.concat((item).selectionManager.getSelections(true));
                }
            }
        }
        return this.selectionsList.map((selectable) => selectable.item);
    }
}

//# sourceMappingURL=data:application/json;base64,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LCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0lTZWxlY3RhYmxlfSBmcm9tICcuL2NvbnRyYWN0cy9JU2VsZWN0YWJsZSc7XHJcbmltcG9ydCB7SVNlbGVjdGlvbk1hbmFnZXJ9IGZyb20gJy4vY29udHJhY3RzL0lTZWxlY3Rpb25NYW5hZ2VyJztcclxuaW1wb3J0IHtJU2VsZWN0aW9uVHVwbGV9IGZyb20gJy4vY29udHJhY3RzL0lTZWxlY3Rpb25UdXBsZSc7XHJcbmV4cG9ydCBjbGFzcyBTZWxlY3Rpb25NYW5hZ2VyIGltcGxlbWVudHMgSVNlbGVjdGlvbk1hbmFnZXIge1xyXG4gICAgcHJpdmF0ZSBzZWxlY3Rpb25zTGlzdCA9IG5ldyBBcnJheTxJU2VsZWN0aW9uVHVwbGU+KCk7XHJcbiAgICBwcml2YXRlIGl0ZW1zOiBBcnJheTxJU2VsZWN0YWJsZT47XHJcbiAgICBwcml2YXRlIGl0ZW1zUHJvcGVydHlOYW1lOiBzdHJpbmc7XHJcbiAgICBkaXNwb3NlKCk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuc2VsZWN0aW9uc0xpc3QubGVuZ3RoID0gMDtcclxuICAgICAgICBkZWxldGUgdGhpcy5zZWxlY3Rpb25zTGlzdDtcclxuICAgICAgICBkZWxldGUgdGhpcy5pdGVtcztcclxuICAgIH1cclxuXHJcbiAgICBsYXN0UHJvY2Vzc2VkSW5kZXg6IG51bWJlcjtcclxuICAgIGdldCBpdGVtc1NvdXJjZSgpOiBBcnJheTxJU2VsZWN0YWJsZT4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLml0ZW1zO1xyXG4gICAgfVxyXG4gICAgc2V0IGl0ZW1zU291cmNlKHZhbHVlOiBBcnJheTxJU2VsZWN0YWJsZT4pIHtcclxuICAgICAgICB0aGlzLml0ZW1zID0gdmFsdWU7XHJcbiAgICAgICAgdGhpcy5jaGVja1NlbGVjdGlvbigpO1xyXG4gICAgfVxyXG4gICAgcHJpdmF0ZSBwcm9jZXNzU2VsZWN0aW9uKGl0ZW06IElTZWxlY3RhYmxlLCBzZWxlY3RlZDogYm9vbGVhbik6IHZvaWQge1xyXG4gICAgICAgIGl0ZW0uc2VsZWN0ZWQgPSBzZWxlY3RlZDtcclxuICAgICAgICBpZiAoaXRlbS5vblNlbGVjdGlvbkNoYW5nZWQgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICBpdGVtLm9uU2VsZWN0aW9uQ2hhbmdlZChzZWxlY3RlZCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChzZWxlY3RlZCA9PT0gdHJ1ZSAmJiBpdGVtLm9uU2VsZWN0ZWQgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICBpdGVtLm9uU2VsZWN0ZWQoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHNlbGVjdGVkID09PSBmYWxzZSAmJiBpdGVtLm9uRGVzZWxlY3RlZCAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIGl0ZW0ub25EZXNlbGVjdGVkKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcHJpdmF0ZSBkZXNlbGVjdEl0ZW0oc2VsZWN0aW9uVHVwbGU6IElTZWxlY3Rpb25UdXBsZSwgcmVjdXJzaXZlOiBib29sZWFuID0gZmFsc2UpOiB2b2lkIHtcclxuICAgICAgICBjb25zdCBpbmRleCA9IHRoaXMuc2VsZWN0aW9uc0xpc3QuZmluZEluZGV4KHNlbGVjdGVkSXRlbSA9PiAoc2VsZWN0ZWRJdGVtLml0ZW0gPT09IHNlbGVjdGlvblR1cGxlLml0ZW0pKTtcclxuICAgICAgICBpZiAoaW5kZXggIT09IC0xKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2VsZWN0aW9uc0xpc3Quc3BsaWNlKGluZGV4LCAxKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5wcm9jZXNzU2VsZWN0aW9uKHNlbGVjdGlvblR1cGxlLml0ZW0sIGZhbHNlKTtcclxuICAgICAgICBpZiAodGhpcy5jYW5SZWN1cnNlKHJlY3Vyc2l2ZSwgc2VsZWN0aW9uVHVwbGUuaXRlbSkpIHtcclxuICAgICAgICAgICAgLyogdHNsaW50OmRpc2FibGU6bm8tYW55ICovXHJcbiAgICAgICAgICAgICgoc2VsZWN0aW9uVHVwbGUuaXRlbSBhcyBhbnkpKS5zZWxlY3Rpb25NYW5hZ2VyLmRlc2VsZWN0QWxsKHRydWUpO1xyXG4gICAgICAgICAgICAvKiB0c2xpbnQ6ZW5hYmxlOm5vLWFueSAqL1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmxhc3RQcm9jZXNzZWRJbmRleCA9IHNlbGVjdGlvblR1cGxlLmluZGV4O1xyXG4gICAgfVxyXG4gICAgcHJpdmF0ZSBzZWxlY3RJdGVtKHNlbGVjdGlvblR1cGxlOiBJU2VsZWN0aW9uVHVwbGUsIHNhdmVQcmV2aW91czogYm9vbGVhbiA9IGZhbHNlLCByZWN1cnNpdmU6IGJvb2xlYW4gPSBmYWxzZSk6IHZvaWQge1xyXG4gICAgICAgIGlmIChzYXZlUHJldmlvdXMpIHtcclxuICAgICAgICAgICAgY29uc3QgaW5kZXggPSB0aGlzLnNlbGVjdGlvbnNMaXN0LmZpbmRJbmRleChzZWxlY3RlZEl0ZW0gPT4gKHNlbGVjdGVkSXRlbS5pdGVtID09PSBzZWxlY3Rpb25UdXBsZS5pdGVtKSk7XHJcbiAgICAgICAgICAgIGlmIChpbmRleCAhPT0gLTEpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMucHJvY2Vzc1NlbGVjdGlvbihzZWxlY3Rpb25UdXBsZS5pdGVtLCBmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGlvbnNMaXN0LnNwbGljZShpbmRleCwgMSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5zZWxlY3Rpb25zTGlzdC5wdXNoKHNlbGVjdGlvblR1cGxlKTtcclxuICAgICAgICAgICAgdGhpcy5wcm9jZXNzU2VsZWN0aW9uKHNlbGVjdGlvblR1cGxlLml0ZW0sIHRydWUpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGxpc3QgPSB0aGlzLnNlbGVjdGlvbnNMaXN0LnNwbGljZSgwLCB0aGlzLnNlbGVjdGlvbnNMaXN0Lmxlbmd0aCk7XHJcbiAgICAgICAgICAgIGxpc3QuZm9yRWFjaChzZWxlY3RlZEl0ZW0gPT4geyB0aGlzLnByb2Nlc3NTZWxlY3Rpb24oc2VsZWN0ZWRJdGVtLml0ZW0sIGZhbHNlKTsgfSk7XHJcbiAgICAgICAgICAgIHRoaXMuc2VsZWN0aW9uc0xpc3QucHVzaChzZWxlY3Rpb25UdXBsZSk7XHJcbiAgICAgICAgICAgIHRoaXMucHJvY2Vzc1NlbGVjdGlvbihzZWxlY3Rpb25UdXBsZS5pdGVtLCB0cnVlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMuY2FuUmVjdXJzZShyZWN1cnNpdmUsIHNlbGVjdGlvblR1cGxlLml0ZW0pKSB7XHJcbiAgICAgICAgICAgIC8qIHRzbGludDpkaXNhYmxlOm5vLWFueSAqL1xyXG4gICAgICAgICAgICAoKHNlbGVjdGlvblR1cGxlLml0ZW0gYXMgYW55KSkuc2VsZWN0aW9uTWFuYWdlci5zZWxlY3RBbGwodHJ1ZSk7XHJcbiAgICAgICAgICAgIC8qIHRzbGludDplbmFibGU6bm8tYW55ICovXHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMubGFzdFByb2Nlc3NlZEluZGV4ID0gc2VsZWN0aW9uVHVwbGUuaW5kZXg7XHJcbiAgICB9XHJcbiAgICBwcml2YXRlIGNhblJlY3Vyc2UocmVjdXJzaXZlOiBib29sZWFuLCAvKiB0c2xpbnQ6ZGlzYWJsZTpuby1hbnkgKi9pdGVtOiBhbnkvKiB0c2xpbnQ6ZW5hYmxlOm5vLWFueSAqLyk6IGJvb2xlYW4ge1xyXG4gICAgICAgIGlmIChyZWN1cnNpdmUgJiYgaXRlbS5zZWxlY3Rpb25NYW5hZ2VyICYmIGl0ZW0uc2VsZWN0aW9uTWFuYWdlciBpbnN0YW5jZW9mIFNlbGVjdGlvbk1hbmFnZXIpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICAgIHByaXZhdGUgZ2V0U2VsZWN0aW9uVHVwbGUoaW5kZXg6IG51bWJlcik6IElTZWxlY3Rpb25UdXBsZSB7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgaW5kZXg6IGluZGV4LFxyXG4gICAgICAgICAgICBpdGVtOiB0aGlzLml0ZW1zU291cmNlW2luZGV4XVxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcbiAgICBwcml2YXRlIGNoZWNrU2VsZWN0aW9uKCk6IHZvaWQge1xyXG4gICAgICAgIGZvciAobGV0IGkgPSB0aGlzLnNlbGVjdGlvbnNMaXN0Lmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHR1cGxlID0gdGhpcy5zZWxlY3Rpb25zTGlzdFtpXTtcclxuICAgICAgICAgICAgaWYgKHRoaXMuaXRlbXNTb3VyY2VbdHVwbGUuaW5kZXhdICE9PSB0dXBsZS5pdGVtKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmRlc2VsZWN0SXRlbSh0dXBsZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBkZXNlbGVjdEFsbChyZWN1cnNpdmU6IGJvb2xlYW4gPSBmYWxzZSk6IHZvaWQge1xyXG4gICAgICAgIGNvbnN0IGxpc3QgPSB0aGlzLnNlbGVjdGlvbnNMaXN0LnNwbGljZSgwLCB0aGlzLnNlbGVjdGlvbnNMaXN0Lmxlbmd0aCk7XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGl0ZW0gPSBsaXN0W2ldLml0ZW07XHJcbiAgICAgICAgICAgIHRoaXMucHJvY2Vzc1NlbGVjdGlvbihpdGVtLCBmYWxzZSk7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmNhblJlY3Vyc2UocmVjdXJzaXZlLCBpdGVtKSkge1xyXG4gICAgICAgICAgICAgICAgLyogdHNsaW50OmRpc2FibGU6bm8tYW55ICovXHJcbiAgICAgICAgICAgICAgICAoKGl0ZW0gYXMgYW55KSkuc2VsZWN0aW9uTWFuYWdlci5kZXNlbGVjdEFsbCh0cnVlKTtcclxuICAgICAgICAgICAgICAgIC8qIHRzbGludDplbmFibGU6bm8tYW55ICovXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5sYXN0UHJvY2Vzc2VkSW5kZXggPSBudWxsO1xyXG4gICAgfVxyXG4gICAgc2VsZWN0QWxsKHJlY3Vyc2l2ZTogYm9vbGVhbiA9IGZhbHNlKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5zZWxlY3RSYW5nZSgwLCB0aGlzLml0ZW1zU291cmNlLmxlbmd0aCAtIDEsIHJlY3Vyc2l2ZSk7XHJcbiAgICB9XHJcbiAgICBzZWxlY3RSYW5nZShmcm9tSW5kZXg6IG51bWJlciwgdG9JbmRleDogbnVtYmVyLCByZWN1cnNpdmU6IGJvb2xlYW4gPSBmYWxzZSk6IHZvaWQge1xyXG4gICAgICAgIGlmICh0b0luZGV4IDwgMCB8fCB0aGlzLml0ZW1zU291cmNlLmxlbmd0aCA8PSB0b0luZGV4IHx8IGZyb21JbmRleCA8IDAgfHwgdGhpcy5pdGVtc1NvdXJjZS5sZW5ndGggPD0gZnJvbUluZGV4KSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3Qgc3RhcnRJbmRleCA9IE1hdGgubWluKGZyb21JbmRleCwgdG9JbmRleCk7XHJcbiAgICAgICAgY29uc3QgZW5kSW5kZXggPSBNYXRoLm1heChmcm9tSW5kZXgsIHRvSW5kZXgpO1xyXG4gICAgICAgIHRoaXMuZGVzZWxlY3RBbGwoKTtcclxuICAgICAgICBjb25zdCB0ZW1wRGF0YSA9IG5ldyBBcnJheTxJU2VsZWN0aW9uVHVwbGU+KCk7XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IHN0YXJ0SW5kZXg7IGkgPD0gZW5kSW5kZXg7IGkrKykge1xyXG4gICAgICAgICAgICBjb25zdCB0dXBsZSA9IHRoaXMuZ2V0U2VsZWN0aW9uVHVwbGUoaSk7XHJcbiAgICAgICAgICAgIHRlbXBEYXRhLnB1c2godHVwbGUpO1xyXG4gICAgICAgICAgICB0aGlzLnByb2Nlc3NTZWxlY3Rpb24odHVwbGUuaXRlbSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmNhblJlY3Vyc2UocmVjdXJzaXZlLCB0dXBsZS5pdGVtKSkge1xyXG4gICAgICAgICAgICAgICAgLyogdHNsaW50OmRpc2FibGU6bm8tYW55ICovXHJcbiAgICAgICAgICAgICAgICAoKHR1cGxlLml0ZW0gYXMgYW55KSkuc2VsZWN0aW9uTWFuYWdlci5zZWxlY3RBbGwodHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAvKiB0c2xpbnQ6ZW5hYmxlOm5vLWFueSAqL1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuc2VsZWN0aW9uc0xpc3Quc3BsaWNlKDAsIHRoaXMuc2VsZWN0aW9uc0xpc3QubGVuZ3RoLCAuLi50ZW1wRGF0YSk7XHJcbiAgICAgICAgdGhpcy5sYXN0UHJvY2Vzc2VkSW5kZXggPSBlbmRJbmRleDtcclxuICAgIH1cclxuXHJcbiAgICBoYXNTZWxlY3Rpb25zKCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnNlbGVjdGlvbnNMaXN0Lmxlbmd0aCAhPT0gMDtcclxuICAgIH1cclxuICAgIGlzSW5kZXhTZWxlY3RlZChpbmRleDogbnVtYmVyKTogYm9vbGVhbiB7XHJcbiAgICAgICAgaWYgKGluZGV4ID49IDAgJiYgdGhpcy5pdGVtc1NvdXJjZS5sZW5ndGggPiBpbmRleCkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5pdGVtc1NvdXJjZVtpbmRleF0uc2VsZWN0ZWQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuXHJcbiAgICBnZXRJdGVtSW5kZXgoaXRlbTogSVNlbGVjdGFibGUpOiBudW1iZXIge1xyXG4gICAgICAgIHJldHVybiB0aGlzLml0ZW1zU291cmNlLmZpbmRJbmRleCh2YWx1ZSA9PiB2YWx1ZSA9PT0gaXRlbSk7XHJcbiAgICB9XHJcbiAgICBnZXRNaW5TZWxlY3RlZEluZGV4KCk6IG51bWJlciB7XHJcbiAgICAgICAgbGV0IG1pbkluZGV4ID0gbnVsbDtcclxuICAgICAgICB0aGlzLnNlbGVjdGlvbnNMaXN0LmZvckVhY2goaXRlbSA9PiB7XHJcbiAgICAgICAgICAgIG1pbkluZGV4ID0gKG1pbkluZGV4ID09PSBudWxsIHx8IGl0ZW0uaW5kZXggPCBtaW5JbmRleCkgPyBpdGVtLmluZGV4IDogbWluSW5kZXg7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIG1pbkluZGV4O1xyXG4gICAgfVxyXG4gICAgZ2V0TWF4U2VsZWN0ZWRJbmRleCgpOiBudW1iZXIge1xyXG4gICAgICAgIGxldCBtYXhJbmRleCA9IG51bGw7XHJcbiAgICAgICAgdGhpcy5zZWxlY3Rpb25zTGlzdC5mb3JFYWNoKGl0ZW0gPT4ge1xyXG4gICAgICAgICAgICBtYXhJbmRleCA9IChtYXhJbmRleCA9PT0gbnVsbCB8fCBpdGVtLmluZGV4ID4gbWF4SW5kZXgpID8gaXRlbS5pbmRleCA6IG1heEluZGV4O1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJldHVybiBtYXhJbmRleDtcclxuICAgIH1cclxuXHJcbiAgICBzZWxlY3RGaXJzdCgpOiB2b2lkIHtcclxuICAgICAgICBpZiAodGhpcy5pdGVtc1NvdXJjZS5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2VsZWN0SXRlbSh0aGlzLmdldFNlbGVjdGlvblR1cGxlKDApKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBzZWxlY3RMYXN0KCk6IHZvaWQge1xyXG4gICAgICAgIGlmICh0aGlzLml0ZW1zU291cmNlLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgdGhpcy5zZWxlY3RJdGVtKHRoaXMuZ2V0U2VsZWN0aW9uVHVwbGUodGhpcy5pdGVtc1NvdXJjZS5sZW5ndGggLSAxKSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHNlbGVjdEluZGV4KGluZGV4OiBudW1iZXIsIHNhdmVQcmV2aW91czogYm9vbGVhbiA9IGZhbHNlLCByZWN1cnNpdmU6IGJvb2xlYW4gPSBmYWxzZSk6IHZvaWQge1xyXG4gICAgICAgIGlmIChpbmRleCA+PSAwICYmIHRoaXMuaXRlbXNTb3VyY2UubGVuZ3RoID4gaW5kZXgpIHtcclxuICAgICAgICAgICAgdGhpcy5zZWxlY3RJdGVtKHRoaXMuZ2V0U2VsZWN0aW9uVHVwbGUoaW5kZXgpLCBzYXZlUHJldmlvdXMsIHJlY3Vyc2l2ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgZGVzZWxlY3RJbmRleChpbmRleDogbnVtYmVyLCByZWN1cnNpdmU6IGJvb2xlYW4gPSBmYWxzZSk6IHZvaWQge1xyXG4gICAgICAgIGlmIChpbmRleCA+PSAwICYmIHRoaXMuaXRlbXNTb3VyY2UubGVuZ3RoID4gaW5kZXgpIHtcclxuICAgICAgICAgICAgdGhpcy5kZXNlbGVjdEl0ZW0odGhpcy5nZXRTZWxlY3Rpb25UdXBsZShpbmRleCksIHJlY3Vyc2l2ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgdG9nZ2xlU2VsZWN0aW9uKGluZGV4OiBudW1iZXIsIHNhdmVQcmV2aW91czogYm9vbGVhbiA9IGZhbHNlLCByZWN1cnNpdmU6IGJvb2xlYW4gPSBmYWxzZSk6IHZvaWQge1xyXG4gICAgICAgIGlmIChpbmRleCA8IDAgfHwgdGhpcy5pdGVtc1NvdXJjZS5sZW5ndGggPD0gaW5kZXgpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCB0dXBsZSA9IHRoaXMuZ2V0U2VsZWN0aW9uVHVwbGUoaW5kZXgpO1xyXG4gICAgICAgIGlmICh0aGlzLmlzSW5kZXhTZWxlY3RlZChpbmRleCkpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuc2VsZWN0aW9uc0xpc3QubGVuZ3RoID09PSAxIHx8ICh0aGlzLnNlbGVjdGlvbnNMaXN0Lmxlbmd0aCA+IDEgJiYgc2F2ZVByZXZpb3VzKSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5kZXNlbGVjdEl0ZW0odHVwbGUsIHJlY3Vyc2l2ZSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdEl0ZW0odHVwbGUsIHNhdmVQcmV2aW91cywgcmVjdXJzaXZlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuc2VsZWN0SXRlbSh0dXBsZSwgc2F2ZVByZXZpb3VzLCByZWN1cnNpdmUpO1xyXG4gICAgfVxyXG4gICAgZ2V0U2VsZWN0aW9ucyhyZWN1cnNpdmU6IGJvb2xlYW4gPSBmYWxzZSk6IEFycmF5PE9iamVjdD4ge1xyXG4gICAgICAgIGlmIChyZWN1cnNpdmUpIHtcclxuICAgICAgICAgICAgbGV0IHJlc3VsdCA9IFtdO1xyXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuc2VsZWN0aW9uc0xpc3QubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGl0ZW0gPSB0aGlzLnNlbGVjdGlvbnNMaXN0W2ldLml0ZW07XHJcbiAgICAgICAgICAgICAgICByZXN1bHQucHVzaChpdGVtKTtcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhblJlY3Vyc2UocmVjdXJzaXZlLCBpdGVtKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIC8qIHRzbGludDpkaXNhYmxlOm5vLWFueSAqL1xyXG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IHJlc3VsdC5jb25jYXQoKChpdGVtIGFzIGFueSkpLnNlbGVjdGlvbk1hbmFnZXIuZ2V0U2VsZWN0aW9ucyh0cnVlKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgLyogdHNsaW50OmVuYWJsZTpuby1hbnkgKi9cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdGhpcy5zZWxlY3Rpb25zTGlzdC5tYXAoKHNlbGVjdGFibGUpID0+IHNlbGVjdGFibGUuaXRlbSk7XHJcbiAgICB9XHJcbn1cclxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
