import * as _ from 'lodash';
import { ParseHelper } from './common/parseHelper';
export class FilterManager {
    constructor(target) {
        this.defaultsApplied = false;
        this.appliedFiltersMapInternal = new Map();
        this.registerFilterTarget(target);
    }
    static registerFilter(targetType, propertyConfig) {
        const typeConfigs = FilterManager.filterPropertiesMap.has(targetType) ? FilterManager.filterPropertiesMap.get(targetType) : new Array();
        typeConfigs.push(propertyConfig);
        FilterManager.filterPropertiesMap.set(targetType, typeConfigs);
    }
    static buildFilterValue(target, value, config) {
        if (config && config.serializeFormatter) {
            return config.serializeFormatter.call(target, value);
        }
        value = config && config.emptyIsNull ? value || null : value;
        if (value && value.toRequest) {
            return value.toRequest();
        }
        if (Array.isArray(value)) {
            const temp = [];
            for (let i = 0; i < value.length; i++) {
                temp[i] = FilterManager.buildFilterValue(target, value[i], null);
            }
            return temp;
        }
        return value;
    }
    dispose() {
        this.appliedFiltersMapInternal.clear();
        delete this.appliedFiltersMapInternal;
    }
    get appliedFiltersMap() {
        return this.appliedFiltersMapInternal;
    }
    resetValues() {
        this.appliedFiltersMapInternal.forEach((targetConfig, target) => {
            for (let i = 0; i < targetConfig.length; i++) {
                const config = targetConfig[i];
                const defaultValue = (typeof config.defaultValue === 'function') ? config.defaultValue.call(target) : config.defaultValue;
                const clonedObject = _.cloneDeep({ defaultValue: defaultValue });
                target[config.propertyName] = clonedObject.defaultValue;
            }
        });
    }
    parseParams(params) {
        this.appliedFiltersMapInternal.forEach((targetConfig, target) => {
            for (let i = 0; i < targetConfig.length; i++) {
                const config = targetConfig[i];
                if (false === this.defaultsApplied && config.defaultValue === undefined) {
                    config.defaultValue = _.cloneDeep({ defaultValue: target[config.propertyName] }).defaultValue;
                }
                if (params && params[config.parameterName] !== undefined && false === config.ignoreOnAutoMap) {
                    let proposedVal = config.emptyIsNull ? params[config.parameterName] || null : params[config.parameterName];
                    proposedVal = config.coerce ? ParseHelper.coerceValue(proposedVal) : proposedVal;
                    target[config.propertyName] = config.parseFormatter ? config.parseFormatter.call(target, proposedVal, params) : proposedVal;
                }
            }
        });
        this.defaultsApplied = true;
    }
    getRequestState(result) {
        result = result || {};
        this.appliedFiltersMapInternal.forEach((targetConfig, target) => {
            for (let i = 0; i < targetConfig.length; i++) {
                const config = targetConfig[i];
                const proposedVal = target[config.propertyName];
                result[config.parameterName] = FilterManager.buildFilterValue(target, proposedVal, config);
            }
        });
        return result;
    }
    getPersistedState(result) {
        result = result || {};
        this.appliedFiltersMapInternal.forEach((targetConfig, target) => {
            for (let i = 0; i < targetConfig.length; i++) {
                const config = targetConfig[i];
                if (!config.persisted) {
                    continue;
                }
                let proposedVal = target[config.propertyName];
                if (proposedVal && proposedVal.toRequest) {
                    proposedVal = proposedVal.toRequest();
                }
                result[config.parameterName] = config.serializeFormatter
                    ? config.serializeFormatter.call(target, proposedVal) : (config.emptyIsNull ? proposedVal || null : proposedVal);
            }
        });
        return result;
    }
    registerFilterTarget(target) {
        let targetConfig = this.appliedFiltersMapInternal.has(target) ? this.appliedFiltersMapInternal.get(target) : new Array();
        FilterManager.filterPropertiesMap.forEach((typeConfig, type) => {
            if (target instanceof type) {
                targetConfig = targetConfig.concat(_.cloneDeep(typeConfig));
            }
        });
        if (targetConfig.length > 0) {
            this.appliedFiltersMapInternal.set(target, targetConfig);
        }
        else {
            this.appliedFiltersMapInternal.delete(target);
        }
    }
}
FilterManager.filterPropertiesMap = new Map();

//# sourceMappingURL=data:application/json;base64,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QUFDO2dCQUN6QixZQUFZLEdBQUcsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7WUFDaEUsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO1FBQ0gsRUFBRSxDQUFDLENBQUMsWUFBWSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzFCLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLFlBQVksQ0FBQyxDQUFDO1FBQzdELENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNKLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDbEQsQ0FBQztJQUNMLENBQUM7QUFJTCxDQUFDO0FBN0dVLGlDQUFtQixHQUFHLElBQUksR0FBRyxFQUE0QixDQTZHbkUiLCJmaWxlIjoiZmlsdGVyTWFuYWdlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIF8gZnJvbSAnbG9kYXNoJztcclxuaW1wb3J0IHtGaWx0ZXJDb25maWd9IGZyb20gJy4vZmlsdGVyQ29uZmlnJztcclxuaW1wb3J0IHtQYXJzZUhlbHBlcn0gZnJvbSAnLi9jb21tb24vcGFyc2VIZWxwZXInO1xyXG5pbXBvcnQge0lGaWx0ZXJNYW5hZ2VyfSBmcm9tICcuL2NvbnRyYWN0cy9JRmlsdGVyTWFuYWdlcic7XHJcblxyXG5leHBvcnQgY2xhc3MgRmlsdGVyTWFuYWdlciBpbXBsZW1lbnRzIElGaWx0ZXJNYW5hZ2VyIHtcclxuXHJcbiAgICBzdGF0aWMgZmlsdGVyUHJvcGVydGllc01hcCA9IG5ldyBNYXA8YW55LCBBcnJheTxGaWx0ZXJDb25maWc+PigpO1xyXG4gICAgc3RhdGljIHJlZ2lzdGVyRmlsdGVyKHRhcmdldFR5cGU6IE9iamVjdCwgcHJvcGVydHlDb25maWc6IEZpbHRlckNvbmZpZyk6IHZvaWQge1xyXG4gICAgICAgIGNvbnN0IHR5cGVDb25maWdzID0gRmlsdGVyTWFuYWdlci5maWx0ZXJQcm9wZXJ0aWVzTWFwLmhhcyh0YXJnZXRUeXBlKSA/IEZpbHRlck1hbmFnZXIuZmlsdGVyUHJvcGVydGllc01hcC5nZXQodGFyZ2V0VHlwZSkgOiBuZXcgQXJyYXk8RmlsdGVyQ29uZmlnPigpO1xyXG4gICAgICAgIHR5cGVDb25maWdzLnB1c2gocHJvcGVydHlDb25maWcpO1xyXG4gICAgICAgIEZpbHRlck1hbmFnZXIuZmlsdGVyUHJvcGVydGllc01hcC5zZXQodGFyZ2V0VHlwZSwgdHlwZUNvbmZpZ3MpO1xyXG4gICAgfVxyXG5cclxuICAgIHN0YXRpYyBidWlsZEZpbHRlclZhbHVlKHRhcmdldDogT2JqZWN0LCB2YWx1ZTogYW55LCBjb25maWc6IEZpbHRlckNvbmZpZyk6IE9iamVjdCB7XHJcbiAgICAgICAgaWYgKGNvbmZpZyAmJiBjb25maWcuc2VyaWFsaXplRm9ybWF0dGVyKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBjb25maWcuc2VyaWFsaXplRm9ybWF0dGVyLmNhbGwodGFyZ2V0LCB2YWx1ZSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB2YWx1ZSA9IGNvbmZpZyAmJiBjb25maWcuZW1wdHlJc051bGwgPyB2YWx1ZSB8fCBudWxsIDogdmFsdWU7XHJcblxyXG4gICAgICAgIGlmICh2YWx1ZSAmJiB2YWx1ZS50b1JlcXVlc3QpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHZhbHVlLnRvUmVxdWVzdCgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcclxuICAgICAgICAgICAgY29uc3QgdGVtcCA9IFtdO1xyXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZhbHVlLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICB0ZW1wW2ldID0gRmlsdGVyTWFuYWdlci5idWlsZEZpbHRlclZhbHVlKHRhcmdldCwgdmFsdWVbaV0sIG51bGwpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiB0ZW1wO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBkZWZhdWx0c0FwcGxpZWQgPSBmYWxzZTtcclxuICAgIHByaXZhdGUgYXBwbGllZEZpbHRlcnNNYXBJbnRlcm5hbCA9IG5ldyBNYXA8T2JqZWN0LCBBcnJheTxGaWx0ZXJDb25maWc+PigpO1xyXG5cclxuICAgIGRpc3Bvc2UoKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5hcHBsaWVkRmlsdGVyc01hcEludGVybmFsLmNsZWFyKCk7XHJcbiAgICAgICAgZGVsZXRlIHRoaXMuYXBwbGllZEZpbHRlcnNNYXBJbnRlcm5hbDtcclxuICAgIH1cclxuICAgIGdldCBhcHBsaWVkRmlsdGVyc01hcCgpOiBNYXA8T2JqZWN0LCBBcnJheTxGaWx0ZXJDb25maWc+PiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuYXBwbGllZEZpbHRlcnNNYXBJbnRlcm5hbDtcclxuICAgIH1cclxuICAgIHJlc2V0VmFsdWVzKCk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuYXBwbGllZEZpbHRlcnNNYXBJbnRlcm5hbC5mb3JFYWNoKCh0YXJnZXRDb25maWcsIHRhcmdldCkgPT4ge1xyXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRhcmdldENvbmZpZy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgY29uZmlnID0gdGFyZ2V0Q29uZmlnW2ldO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZGVmYXVsdFZhbHVlID0gKHR5cGVvZiBjb25maWcuZGVmYXVsdFZhbHVlID09PSAnZnVuY3Rpb24nKSA/IChjb25maWcuZGVmYXVsdFZhbHVlIGFzIEZ1bmN0aW9uKS5jYWxsKHRhcmdldCkgOiBjb25maWcuZGVmYXVsdFZhbHVlO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgY2xvbmVkT2JqZWN0ID0gXy5jbG9uZURlZXAoeyBkZWZhdWx0VmFsdWU6IGRlZmF1bHRWYWx1ZSB9KTtcclxuICAgICAgICAgICAgICAgIHRhcmdldFtjb25maWcucHJvcGVydHlOYW1lXSA9IGNsb25lZE9iamVjdC5kZWZhdWx0VmFsdWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIHBhcnNlUGFyYW1zKHBhcmFtczogT2JqZWN0KTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5hcHBsaWVkRmlsdGVyc01hcEludGVybmFsLmZvckVhY2goKHRhcmdldENvbmZpZywgdGFyZ2V0KSA9PiB7XHJcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGFyZ2V0Q29uZmlnLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBjb25maWcgPSB0YXJnZXRDb25maWdbaV07XHJcbiAgICAgICAgICAgICAgICBpZiAoZmFsc2UgPT09IHRoaXMuZGVmYXVsdHNBcHBsaWVkICYmIGNvbmZpZy5kZWZhdWx0VmFsdWUgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbmZpZy5kZWZhdWx0VmFsdWUgPSBfLmNsb25lRGVlcCh7IGRlZmF1bHRWYWx1ZTogdGFyZ2V0W2NvbmZpZy5wcm9wZXJ0eU5hbWVdIH0pLmRlZmF1bHRWYWx1ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBpZiAocGFyYW1zICYmIHBhcmFtc1tjb25maWcucGFyYW1ldGVyTmFtZV0gIT09IHVuZGVmaW5lZCAmJiBmYWxzZSA9PT0gY29uZmlnLmlnbm9yZU9uQXV0b01hcCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBwcm9wb3NlZFZhbCA9IGNvbmZpZy5lbXB0eUlzTnVsbCA/IHBhcmFtc1tjb25maWcucGFyYW1ldGVyTmFtZV0gfHwgbnVsbCA6IHBhcmFtc1tjb25maWcucGFyYW1ldGVyTmFtZV07XHJcbiAgICAgICAgICAgICAgICAgICAgcHJvcG9zZWRWYWwgPSBjb25maWcuY29lcmNlID8gUGFyc2VIZWxwZXIuY29lcmNlVmFsdWUocHJvcG9zZWRWYWwpIDogcHJvcG9zZWRWYWw7XHJcbiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0W2NvbmZpZy5wcm9wZXJ0eU5hbWVdID0gY29uZmlnLnBhcnNlRm9ybWF0dGVyID8gY29uZmlnLnBhcnNlRm9ybWF0dGVyLmNhbGwodGFyZ2V0LCBwcm9wb3NlZFZhbCwgcGFyYW1zKSA6IHByb3Bvc2VkVmFsO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdGhpcy5kZWZhdWx0c0FwcGxpZWQgPSB0cnVlO1xyXG4gICAgfVxyXG4gICAgZ2V0UmVxdWVzdFN0YXRlKHJlc3VsdD86IE9iamVjdCk6IE9iamVjdCB7XHJcbiAgICAgICAgcmVzdWx0ID0gcmVzdWx0IHx8IHt9O1xyXG4gICAgICAgIHRoaXMuYXBwbGllZEZpbHRlcnNNYXBJbnRlcm5hbC5mb3JFYWNoKCh0YXJnZXRDb25maWcsIHRhcmdldCkgPT4ge1xyXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRhcmdldENvbmZpZy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgY29uZmlnID0gdGFyZ2V0Q29uZmlnW2ldO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcHJvcG9zZWRWYWwgPSB0YXJnZXRbY29uZmlnLnByb3BlcnR5TmFtZV07XHJcbiAgICAgICAgICAgICAgICByZXN1bHRbY29uZmlnLnBhcmFtZXRlck5hbWVdID0gRmlsdGVyTWFuYWdlci5idWlsZEZpbHRlclZhbHVlKHRhcmdldCwgcHJvcG9zZWRWYWwsIGNvbmZpZyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgfVxyXG4gICAgZ2V0UGVyc2lzdGVkU3RhdGUocmVzdWx0PzogT2JqZWN0KTogT2JqZWN0IHtcclxuICAgICAgICByZXN1bHQgPSByZXN1bHQgfHwge307XHJcbiAgICAgICAgdGhpcy5hcHBsaWVkRmlsdGVyc01hcEludGVybmFsLmZvckVhY2goKHRhcmdldENvbmZpZywgdGFyZ2V0KSA9PiB7XHJcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGFyZ2V0Q29uZmlnLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBjb25maWcgPSB0YXJnZXRDb25maWdbaV07XHJcbiAgICAgICAgICAgICAgICBpZiAoIWNvbmZpZy5wZXJzaXN0ZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGxldCBwcm9wb3NlZFZhbCA9IHRhcmdldFtjb25maWcucHJvcGVydHlOYW1lXTtcclxuICAgICAgICAgICAgICAgIGlmIChwcm9wb3NlZFZhbCAmJiBwcm9wb3NlZFZhbC50b1JlcXVlc3QpIHtcclxuICAgICAgICAgICAgICAgICAgICBwcm9wb3NlZFZhbCA9IHByb3Bvc2VkVmFsLnRvUmVxdWVzdCgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmVzdWx0W2NvbmZpZy5wYXJhbWV0ZXJOYW1lXSA9IGNvbmZpZy5zZXJpYWxpemVGb3JtYXR0ZXJcclxuICAgICAgICAgICAgICAgICAgICA/IGNvbmZpZy5zZXJpYWxpemVGb3JtYXR0ZXIuY2FsbCh0YXJnZXQsIHByb3Bvc2VkVmFsKSA6IChjb25maWcuZW1wdHlJc051bGwgPyBwcm9wb3NlZFZhbCB8fCBudWxsIDogcHJvcG9zZWRWYWwpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH1cclxuICAgIHJlZ2lzdGVyRmlsdGVyVGFyZ2V0KHRhcmdldDogT2JqZWN0KTogdm9pZCB7XHJcbiAgICAgICAgbGV0IHRhcmdldENvbmZpZyA9IHRoaXMuYXBwbGllZEZpbHRlcnNNYXBJbnRlcm5hbC5oYXModGFyZ2V0KSA/IHRoaXMuYXBwbGllZEZpbHRlcnNNYXBJbnRlcm5hbC5nZXQodGFyZ2V0KSA6IG5ldyBBcnJheTxGaWx0ZXJDb25maWc+KCk7XHJcbiAgICAgICAgRmlsdGVyTWFuYWdlci5maWx0ZXJQcm9wZXJ0aWVzTWFwLmZvckVhY2goKHR5cGVDb25maWcsIHR5cGUpID0+IHtcclxuICAgICAgICAgICAgaWYgKHRhcmdldCBpbnN0YW5jZW9mIHR5cGUpIHtcclxuICAgICAgICAgICAgICAgIHRhcmdldENvbmZpZyA9IHRhcmdldENvbmZpZy5jb25jYXQoXy5jbG9uZURlZXAodHlwZUNvbmZpZykpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgaWYgKHRhcmdldENvbmZpZy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgIHRoaXMuYXBwbGllZEZpbHRlcnNNYXBJbnRlcm5hbC5zZXQodGFyZ2V0LCB0YXJnZXRDb25maWcpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuYXBwbGllZEZpbHRlcnNNYXBJbnRlcm5hbC5kZWxldGUodGFyZ2V0KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBjb25zdHJ1Y3Rvcih0YXJnZXQ6IE9iamVjdCkge1xyXG4gICAgICAgIHRoaXMucmVnaXN0ZXJGaWx0ZXJUYXJnZXQodGFyZ2V0KTtcclxuICAgIH1cclxufVxyXG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
