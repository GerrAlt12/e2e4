define(["require", "exports"], function (require, exports) {
    "use strict";
    var SelectionManager = (function () {
        function SelectionManager() {
            this.selectionsList = new Array();
        }
        SelectionManager.prototype.dispose = function () {
            this.selectionsList.length = 0;
            delete this.selectionsList;
            delete this.items;
        };
        Object.defineProperty(SelectionManager.prototype, "itemsSource", {
            get: function () {
                return this.items;
            },
            set: function (value) {
                this.items = value;
                this.checkSelection();
            },
            enumerable: true,
            configurable: true
        });
        SelectionManager.prototype.processSelection = function (item, selected) {
            item.selected = selected;
            if (item.onSelectionChanged !== undefined) {
                item.onSelectionChanged(selected);
            }
            if (selected === true && item.onSelected !== undefined) {
                item.onSelected();
            }
            if (selected === false && item.onDeselected !== undefined) {
                item.onDeselected();
            }
        };
        SelectionManager.prototype.deselectItem = function (selectionTuple, recursive) {
            if (recursive === void 0) { recursive = false; }
            var index = this.selectionsList.findIndex(function (selectedItem) { return (selectedItem.item === selectionTuple.item); });
            if (index !== -1) {
                this.selectionsList.splice(index, 1);
            }
            this.processSelection(selectionTuple.item, false);
            if (this.canRecurse(recursive, selectionTuple.item)) {
                (selectionTuple.item).selectionManager.deselectAll(true);
            }
            this.lastProcessedIndex = selectionTuple.index;
        };
        SelectionManager.prototype.selectItem = function (selectionTuple, savePrevious, recursive) {
            var _this = this;
            if (savePrevious === void 0) { savePrevious = false; }
            if (recursive === void 0) { recursive = false; }
            if (savePrevious) {
                var index = this.selectionsList.findIndex(function (selectedItem) { return (selectedItem.item === selectionTuple.item); });
                if (index !== -1) {
                    this.processSelection(selectionTuple.item, false);
                    this.selectionsList.splice(index, 1);
                }
                this.selectionsList.push(selectionTuple);
                this.processSelection(selectionTuple.item, true);
            }
            else {
                var list = this.selectionsList.splice(0, this.selectionsList.length);
                list.forEach(function (selectedItem) { _this.processSelection(selectedItem.item, false); });
                this.selectionsList.push(selectionTuple);
                this.processSelection(selectionTuple.item, true);
            }
            if (this.canRecurse(recursive, selectionTuple.item)) {
                (selectionTuple.item).selectionManager.selectAll(true);
            }
            this.lastProcessedIndex = selectionTuple.index;
        };
        SelectionManager.prototype.canRecurse = function (recursive, item) {
            if (recursive && item.selectionManager && item.selectionManager instanceof SelectionManager) {
                return true;
            }
            return false;
        };
        SelectionManager.prototype.getSelectionTuple = function (index) {
            return {
                index: index,
                item: this.itemsSource[index]
            };
        };
        SelectionManager.prototype.checkSelection = function () {
            for (var i = this.selectionsList.length - 1; i >= 0; i--) {
                var tuple = this.selectionsList[i];
                if (this.itemsSource[tuple.index] !== tuple.item) {
                    this.deselectItem(tuple);
                }
            }
        };
        SelectionManager.prototype.deselectAll = function (recursive) {
            if (recursive === void 0) { recursive = false; }
            var list = this.selectionsList.splice(0, this.selectionsList.length);
            for (var i = 0; i < list.length; i++) {
                var item = list[i].item;
                this.processSelection(item, false);
                if (this.canRecurse(recursive, item)) {
                    (item).selectionManager.deselectAll(true);
                }
            }
            this.lastProcessedIndex = null;
        };
        SelectionManager.prototype.selectAll = function (recursive) {
            if (recursive === void 0) { recursive = false; }
            this.selectRange(0, this.itemsSource.length - 1, recursive);
        };
        SelectionManager.prototype.selectRange = function (fromIndex, toIndex, recursive) {
            if (recursive === void 0) { recursive = false; }
            if (toIndex < 0 || this.itemsSource.length <= toIndex || fromIndex < 0 || this.itemsSource.length <= fromIndex) {
                return;
            }
            var startIndex = Math.min(fromIndex, toIndex);
            var endIndex = Math.max(fromIndex, toIndex);
            this.deselectAll();
            var tempData = new Array();
            for (var i = startIndex; i <= endIndex; i++) {
                var tuple = this.getSelectionTuple(i);
                tempData.push(tuple);
                this.processSelection(tuple.item, true);
                if (this.canRecurse(recursive, tuple.item)) {
                    (tuple.item).selectionManager.selectAll(true);
                }
            }
            (_a = this.selectionsList).splice.apply(_a, [0, this.selectionsList.length].concat(tempData));
            this.lastProcessedIndex = endIndex;
            var _a;
        };
        SelectionManager.prototype.hasSelections = function () {
            return this.selectionsList.length !== 0;
        };
        SelectionManager.prototype.isIndexSelected = function (index) {
            if (index >= 0 && this.itemsSource.length > index) {
                return this.itemsSource[index].selected;
            }
            return false;
        };
        SelectionManager.prototype.getItemIndex = function (item) {
            return this.itemsSource.findIndex(function (value) { return value === item; });
        };
        SelectionManager.prototype.getMinSelectedIndex = function () {
            var minIndex = null;
            this.selectionsList.forEach(function (item) {
                minIndex = (minIndex === null || item.index < minIndex) ? item.index : minIndex;
            });
            return minIndex;
        };
        SelectionManager.prototype.getMaxSelectedIndex = function () {
            var maxIndex = null;
            this.selectionsList.forEach(function (item) {
                maxIndex = (maxIndex === null || item.index > maxIndex) ? item.index : maxIndex;
            });
            return maxIndex;
        };
        SelectionManager.prototype.selectFirst = function () {
            if (this.itemsSource.length > 0) {
                this.selectItem(this.getSelectionTuple(0));
            }
        };
        SelectionManager.prototype.selectLast = function () {
            if (this.itemsSource.length > 0) {
                this.selectItem(this.getSelectionTuple(this.itemsSource.length - 1));
            }
        };
        SelectionManager.prototype.selectIndex = function (index, savePrevious, recursive) {
            if (savePrevious === void 0) { savePrevious = false; }
            if (recursive === void 0) { recursive = false; }
            if (index >= 0 && this.itemsSource.length > index) {
                this.selectItem(this.getSelectionTuple(index), savePrevious, recursive);
            }
        };
        SelectionManager.prototype.deselectIndex = function (index, recursive) {
            if (recursive === void 0) { recursive = false; }
            if (index >= 0 && this.itemsSource.length > index) {
                this.deselectItem(this.getSelectionTuple(index), recursive);
            }
        };
        SelectionManager.prototype.toggleSelection = function (index, savePrevious, recursive) {
            if (savePrevious === void 0) { savePrevious = false; }
            if (recursive === void 0) { recursive = false; }
            if (index < 0 || this.itemsSource.length <= index) {
                return;
            }
            var tuple = this.getSelectionTuple(index);
            if (this.isIndexSelected(index)) {
                if (this.selectionsList.length === 1 || (this.selectionsList.length > 1 && savePrevious)) {
                    this.deselectItem(tuple, recursive);
                }
                else {
                    this.selectItem(tuple, savePrevious, recursive);
                }
                return;
            }
            this.selectItem(tuple, savePrevious, recursive);
        };
        SelectionManager.prototype.getSelections = function (recursive) {
            if (recursive === void 0) { recursive = false; }
            if (recursive) {
                var result = [];
                for (var i = 0; i < this.selectionsList.length; i++) {
                    var item = this.selectionsList[i].item;
                    result.push(item);
                    if (this.canRecurse(recursive, item)) {
                        result = result.concat((item).selectionManager.getSelections(true));
                    }
                }
            }
            return this.selectionsList.map(function (selectable) { return selectable.item; });
        };
        return SelectionManager;
    }());
    exports.SelectionManager = SelectionManager;
});

//# sourceMappingURL=data:application/json;base64,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SSxDQUFDO29CQUN6QyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO29CQUNsQixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLFNBQVMsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7d0JBQ25DLE1BQU0sR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUUsSUFBWSxDQUFDLENBQUMsZ0JBQWdCLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7b0JBQ2pGLENBQUM7Z0JBQ0wsQ0FBQztZQUNMLENBQUM7WUFDRCxNQUFNLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsVUFBQyxVQUFVLElBQUssT0FBQSxVQUFVLENBQUMsSUFBSSxFQUFmLENBQWUsQ0FBQyxDQUFDO1FBQ3BFLENBQUM7UUFDTCx1QkFBQztJQUFELENBaE1BLEFBZ01DLElBQUE7SUFoTVksd0JBQWdCLG1CQWdNNUIsQ0FBQSIsImZpbGUiOiJzZWxlY3Rpb25NYW5hZ2VyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtJU2VsZWN0YWJsZX0gZnJvbSAnLi9jb250cmFjdHMvSVNlbGVjdGFibGUnO1xyXG5pbXBvcnQge0lTZWxlY3Rpb25NYW5hZ2VyfSBmcm9tICcuL2NvbnRyYWN0cy9JU2VsZWN0aW9uTWFuYWdlcic7XHJcbmltcG9ydCB7SVNlbGVjdGlvblR1cGxlfSBmcm9tICcuL2NvbnRyYWN0cy9JU2VsZWN0aW9uVHVwbGUnO1xyXG5leHBvcnQgY2xhc3MgU2VsZWN0aW9uTWFuYWdlciBpbXBsZW1lbnRzIElTZWxlY3Rpb25NYW5hZ2VyIHtcclxuICAgIHByaXZhdGUgc2VsZWN0aW9uc0xpc3QgPSBuZXcgQXJyYXk8SVNlbGVjdGlvblR1cGxlPigpO1xyXG4gICAgcHJpdmF0ZSBpdGVtczogQXJyYXk8SVNlbGVjdGFibGU+O1xyXG4gICAgcHJpdmF0ZSBpdGVtc1Byb3BlcnR5TmFtZTogc3RyaW5nO1xyXG4gICAgZGlzcG9zZSgpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLnNlbGVjdGlvbnNMaXN0Lmxlbmd0aCA9IDA7XHJcbiAgICAgICAgZGVsZXRlIHRoaXMuc2VsZWN0aW9uc0xpc3Q7XHJcbiAgICAgICAgZGVsZXRlIHRoaXMuaXRlbXM7XHJcbiAgICB9XHJcblxyXG4gICAgbGFzdFByb2Nlc3NlZEluZGV4OiBudW1iZXI7XHJcbiAgICBnZXQgaXRlbXNTb3VyY2UoKTogQXJyYXk8SVNlbGVjdGFibGU+IHtcclxuICAgICAgICByZXR1cm4gdGhpcy5pdGVtcztcclxuICAgIH1cclxuICAgIHNldCBpdGVtc1NvdXJjZSh2YWx1ZTogQXJyYXk8SVNlbGVjdGFibGU+KSB7XHJcbiAgICAgICAgdGhpcy5pdGVtcyA9IHZhbHVlO1xyXG4gICAgICAgIHRoaXMuY2hlY2tTZWxlY3Rpb24oKTtcclxuICAgIH1cclxuICAgIHByaXZhdGUgcHJvY2Vzc1NlbGVjdGlvbihpdGVtOiBJU2VsZWN0YWJsZSwgc2VsZWN0ZWQ6IGJvb2xlYW4pOiB2b2lkIHtcclxuICAgICAgICBpdGVtLnNlbGVjdGVkID0gc2VsZWN0ZWQ7XHJcbiAgICAgICAgaWYgKGl0ZW0ub25TZWxlY3Rpb25DaGFuZ2VkICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgaXRlbS5vblNlbGVjdGlvbkNoYW5nZWQoc2VsZWN0ZWQpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoc2VsZWN0ZWQgPT09IHRydWUgJiYgaXRlbS5vblNlbGVjdGVkICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgaXRlbS5vblNlbGVjdGVkKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChzZWxlY3RlZCA9PT0gZmFsc2UgJiYgaXRlbS5vbkRlc2VsZWN0ZWQgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICBpdGVtLm9uRGVzZWxlY3RlZCgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHByaXZhdGUgZGVzZWxlY3RJdGVtKHNlbGVjdGlvblR1cGxlOiBJU2VsZWN0aW9uVHVwbGUsIHJlY3Vyc2l2ZTogYm9vbGVhbiA9IGZhbHNlKTogdm9pZCB7XHJcbiAgICAgICAgY29uc3QgaW5kZXggPSB0aGlzLnNlbGVjdGlvbnNMaXN0LmZpbmRJbmRleChzZWxlY3RlZEl0ZW0gPT4gKHNlbGVjdGVkSXRlbS5pdGVtID09PSBzZWxlY3Rpb25UdXBsZS5pdGVtKSk7XHJcbiAgICAgICAgaWYgKGluZGV4ICE9PSAtMSkge1xyXG4gICAgICAgICAgICB0aGlzLnNlbGVjdGlvbnNMaXN0LnNwbGljZShpbmRleCwgMSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMucHJvY2Vzc1NlbGVjdGlvbihzZWxlY3Rpb25UdXBsZS5pdGVtLCBmYWxzZSk7XHJcbiAgICAgICAgaWYgKHRoaXMuY2FuUmVjdXJzZShyZWN1cnNpdmUsIHNlbGVjdGlvblR1cGxlLml0ZW0pKSB7XHJcbiAgICAgICAgICAgICgoc2VsZWN0aW9uVHVwbGUuaXRlbSBhcyBhbnkpKS5zZWxlY3Rpb25NYW5hZ2VyLmRlc2VsZWN0QWxsKHRydWUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmxhc3RQcm9jZXNzZWRJbmRleCA9IHNlbGVjdGlvblR1cGxlLmluZGV4O1xyXG4gICAgfVxyXG4gICAgcHJpdmF0ZSBzZWxlY3RJdGVtKHNlbGVjdGlvblR1cGxlOiBJU2VsZWN0aW9uVHVwbGUsIHNhdmVQcmV2aW91czogYm9vbGVhbiA9IGZhbHNlLCByZWN1cnNpdmU6IGJvb2xlYW4gPSBmYWxzZSk6IHZvaWQge1xyXG4gICAgICAgIGlmIChzYXZlUHJldmlvdXMpIHtcclxuICAgICAgICAgICAgY29uc3QgaW5kZXggPSB0aGlzLnNlbGVjdGlvbnNMaXN0LmZpbmRJbmRleChzZWxlY3RlZEl0ZW0gPT4gKHNlbGVjdGVkSXRlbS5pdGVtID09PSBzZWxlY3Rpb25UdXBsZS5pdGVtKSk7XHJcbiAgICAgICAgICAgIGlmIChpbmRleCAhPT0gLTEpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMucHJvY2Vzc1NlbGVjdGlvbihzZWxlY3Rpb25UdXBsZS5pdGVtLCBmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGlvbnNMaXN0LnNwbGljZShpbmRleCwgMSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5zZWxlY3Rpb25zTGlzdC5wdXNoKHNlbGVjdGlvblR1cGxlKTtcclxuICAgICAgICAgICAgdGhpcy5wcm9jZXNzU2VsZWN0aW9uKHNlbGVjdGlvblR1cGxlLml0ZW0sIHRydWUpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGxpc3QgPSB0aGlzLnNlbGVjdGlvbnNMaXN0LnNwbGljZSgwLCB0aGlzLnNlbGVjdGlvbnNMaXN0Lmxlbmd0aCk7XHJcbiAgICAgICAgICAgIGxpc3QuZm9yRWFjaChzZWxlY3RlZEl0ZW0gPT4geyB0aGlzLnByb2Nlc3NTZWxlY3Rpb24oc2VsZWN0ZWRJdGVtLml0ZW0sIGZhbHNlKTsgfSk7XHJcbiAgICAgICAgICAgIHRoaXMuc2VsZWN0aW9uc0xpc3QucHVzaChzZWxlY3Rpb25UdXBsZSk7XHJcbiAgICAgICAgICAgIHRoaXMucHJvY2Vzc1NlbGVjdGlvbihzZWxlY3Rpb25UdXBsZS5pdGVtLCB0cnVlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMuY2FuUmVjdXJzZShyZWN1cnNpdmUsIHNlbGVjdGlvblR1cGxlLml0ZW0pKSB7XHJcbiAgICAgICAgICAgICgoc2VsZWN0aW9uVHVwbGUuaXRlbSBhcyBhbnkpKS5zZWxlY3Rpb25NYW5hZ2VyLnNlbGVjdEFsbCh0cnVlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5sYXN0UHJvY2Vzc2VkSW5kZXggPSBzZWxlY3Rpb25UdXBsZS5pbmRleDtcclxuICAgIH1cclxuICAgIHByaXZhdGUgY2FuUmVjdXJzZShyZWN1cnNpdmU6IGJvb2xlYW4sIGl0ZW06IGFueSk6IGJvb2xlYW4ge1xyXG4gICAgICAgIGlmIChyZWN1cnNpdmUgJiYgaXRlbS5zZWxlY3Rpb25NYW5hZ2VyICYmIGl0ZW0uc2VsZWN0aW9uTWFuYWdlciBpbnN0YW5jZW9mIFNlbGVjdGlvbk1hbmFnZXIpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICAgIHByaXZhdGUgZ2V0U2VsZWN0aW9uVHVwbGUoaW5kZXg6IG51bWJlcik6IElTZWxlY3Rpb25UdXBsZSB7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgaW5kZXg6IGluZGV4LFxyXG4gICAgICAgICAgICBpdGVtOiB0aGlzLml0ZW1zU291cmNlW2luZGV4XVxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcbiAgICBwcml2YXRlIGNoZWNrU2VsZWN0aW9uKCk6IHZvaWQge1xyXG4gICAgICAgIGZvciAobGV0IGkgPSB0aGlzLnNlbGVjdGlvbnNMaXN0Lmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHR1cGxlID0gdGhpcy5zZWxlY3Rpb25zTGlzdFtpXTtcclxuICAgICAgICAgICAgaWYgKHRoaXMuaXRlbXNTb3VyY2VbdHVwbGUuaW5kZXhdICE9PSB0dXBsZS5pdGVtKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmRlc2VsZWN0SXRlbSh0dXBsZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBkZXNlbGVjdEFsbChyZWN1cnNpdmU6IGJvb2xlYW4gPSBmYWxzZSk6IHZvaWQge1xyXG4gICAgICAgIGNvbnN0IGxpc3QgPSB0aGlzLnNlbGVjdGlvbnNMaXN0LnNwbGljZSgwLCB0aGlzLnNlbGVjdGlvbnNMaXN0Lmxlbmd0aCk7XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGl0ZW0gPSBsaXN0W2ldLml0ZW07XHJcbiAgICAgICAgICAgIHRoaXMucHJvY2Vzc1NlbGVjdGlvbihpdGVtLCBmYWxzZSk7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmNhblJlY3Vyc2UocmVjdXJzaXZlLCBpdGVtKSkge1xyXG4gICAgICAgICAgICAgICAgKChpdGVtIGFzIGFueSkpLnNlbGVjdGlvbk1hbmFnZXIuZGVzZWxlY3RBbGwodHJ1ZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5sYXN0UHJvY2Vzc2VkSW5kZXggPSBudWxsO1xyXG4gICAgfVxyXG4gICAgc2VsZWN0QWxsKHJlY3Vyc2l2ZTogYm9vbGVhbiA9IGZhbHNlKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5zZWxlY3RSYW5nZSgwLCB0aGlzLml0ZW1zU291cmNlLmxlbmd0aCAtIDEsIHJlY3Vyc2l2ZSk7XHJcbiAgICB9XHJcbiAgICBzZWxlY3RSYW5nZShmcm9tSW5kZXg6IG51bWJlciwgdG9JbmRleDogbnVtYmVyLCByZWN1cnNpdmU6IGJvb2xlYW4gPSBmYWxzZSk6IHZvaWQge1xyXG4gICAgICAgIGlmICh0b0luZGV4IDwgMCB8fCB0aGlzLml0ZW1zU291cmNlLmxlbmd0aCA8PSB0b0luZGV4IHx8IGZyb21JbmRleCA8IDAgfHwgdGhpcy5pdGVtc1NvdXJjZS5sZW5ndGggPD0gZnJvbUluZGV4KSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3Qgc3RhcnRJbmRleCA9IE1hdGgubWluKGZyb21JbmRleCwgdG9JbmRleCk7XHJcbiAgICAgICAgY29uc3QgZW5kSW5kZXggPSBNYXRoLm1heChmcm9tSW5kZXgsIHRvSW5kZXgpO1xyXG4gICAgICAgIHRoaXMuZGVzZWxlY3RBbGwoKTtcclxuICAgICAgICBjb25zdCB0ZW1wRGF0YSA9IG5ldyBBcnJheTxJU2VsZWN0aW9uVHVwbGU+KCk7XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IHN0YXJ0SW5kZXg7IGkgPD0gZW5kSW5kZXg7IGkrKykge1xyXG4gICAgICAgICAgICBjb25zdCB0dXBsZSA9IHRoaXMuZ2V0U2VsZWN0aW9uVHVwbGUoaSk7XHJcbiAgICAgICAgICAgIHRlbXBEYXRhLnB1c2godHVwbGUpO1xyXG4gICAgICAgICAgICB0aGlzLnByb2Nlc3NTZWxlY3Rpb24odHVwbGUuaXRlbSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmNhblJlY3Vyc2UocmVjdXJzaXZlLCB0dXBsZS5pdGVtKSkge1xyXG4gICAgICAgICAgICAgICAgKCh0dXBsZS5pdGVtIGFzIGFueSkpLnNlbGVjdGlvbk1hbmFnZXIuc2VsZWN0QWxsKHRydWUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuc2VsZWN0aW9uc0xpc3Quc3BsaWNlKDAsIHRoaXMuc2VsZWN0aW9uc0xpc3QubGVuZ3RoLCAuLi50ZW1wRGF0YSk7XHJcbiAgICAgICAgdGhpcy5sYXN0UHJvY2Vzc2VkSW5kZXggPSBlbmRJbmRleDtcclxuICAgIH1cclxuXHJcbiAgICBoYXNTZWxlY3Rpb25zKCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnNlbGVjdGlvbnNMaXN0Lmxlbmd0aCAhPT0gMDtcclxuICAgIH1cclxuICAgIGlzSW5kZXhTZWxlY3RlZChpbmRleDogbnVtYmVyKTogYm9vbGVhbiB7XHJcbiAgICAgICAgaWYgKGluZGV4ID49IDAgJiYgdGhpcy5pdGVtc1NvdXJjZS5sZW5ndGggPiBpbmRleCkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5pdGVtc1NvdXJjZVtpbmRleF0uc2VsZWN0ZWQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuXHJcbiAgICBnZXRJdGVtSW5kZXgoaXRlbTogSVNlbGVjdGFibGUpOiBudW1iZXIge1xyXG4gICAgICAgIHJldHVybiB0aGlzLml0ZW1zU291cmNlLmZpbmRJbmRleCh2YWx1ZSA9PiB2YWx1ZSA9PT0gaXRlbSk7XHJcbiAgICB9XHJcbiAgICBnZXRNaW5TZWxlY3RlZEluZGV4KCk6IG51bWJlciB7XHJcbiAgICAgICAgbGV0IG1pbkluZGV4ID0gbnVsbDtcclxuICAgICAgICB0aGlzLnNlbGVjdGlvbnNMaXN0LmZvckVhY2goaXRlbSA9PiB7XHJcbiAgICAgICAgICAgIG1pbkluZGV4ID0gKG1pbkluZGV4ID09PSBudWxsIHx8IGl0ZW0uaW5kZXggPCBtaW5JbmRleCkgPyBpdGVtLmluZGV4IDogbWluSW5kZXg7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIG1pbkluZGV4O1xyXG4gICAgfVxyXG4gICAgZ2V0TWF4U2VsZWN0ZWRJbmRleCgpOiBudW1iZXIge1xyXG4gICAgICAgIGxldCBtYXhJbmRleCA9IG51bGw7XHJcbiAgICAgICAgdGhpcy5zZWxlY3Rpb25zTGlzdC5mb3JFYWNoKGl0ZW0gPT4ge1xyXG4gICAgICAgICAgICBtYXhJbmRleCA9IChtYXhJbmRleCA9PT0gbnVsbCB8fCBpdGVtLmluZGV4ID4gbWF4SW5kZXgpID8gaXRlbS5pbmRleCA6IG1heEluZGV4O1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJldHVybiBtYXhJbmRleDtcclxuICAgIH1cclxuXHJcbiAgICBzZWxlY3RGaXJzdCgpOiB2b2lkIHtcclxuICAgICAgICBpZiAodGhpcy5pdGVtc1NvdXJjZS5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2VsZWN0SXRlbSh0aGlzLmdldFNlbGVjdGlvblR1cGxlKDApKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBzZWxlY3RMYXN0KCk6IHZvaWQge1xyXG4gICAgICAgIGlmICh0aGlzLml0ZW1zU291cmNlLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgdGhpcy5zZWxlY3RJdGVtKHRoaXMuZ2V0U2VsZWN0aW9uVHVwbGUodGhpcy5pdGVtc1NvdXJjZS5sZW5ndGggLSAxKSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHNlbGVjdEluZGV4KGluZGV4OiBudW1iZXIsIHNhdmVQcmV2aW91czogYm9vbGVhbiA9IGZhbHNlLCByZWN1cnNpdmU6IGJvb2xlYW4gPSBmYWxzZSk6IHZvaWQge1xyXG4gICAgICAgIGlmIChpbmRleCA+PSAwICYmIHRoaXMuaXRlbXNTb3VyY2UubGVuZ3RoID4gaW5kZXgpIHtcclxuICAgICAgICAgICAgdGhpcy5zZWxlY3RJdGVtKHRoaXMuZ2V0U2VsZWN0aW9uVHVwbGUoaW5kZXgpLCBzYXZlUHJldmlvdXMsIHJlY3Vyc2l2ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgZGVzZWxlY3RJbmRleChpbmRleDogbnVtYmVyLCByZWN1cnNpdmU6IGJvb2xlYW4gPSBmYWxzZSk6IHZvaWQge1xyXG4gICAgICAgIGlmIChpbmRleCA+PSAwICYmIHRoaXMuaXRlbXNTb3VyY2UubGVuZ3RoID4gaW5kZXgpIHtcclxuICAgICAgICAgICAgdGhpcy5kZXNlbGVjdEl0ZW0odGhpcy5nZXRTZWxlY3Rpb25UdXBsZShpbmRleCksIHJlY3Vyc2l2ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgdG9nZ2xlU2VsZWN0aW9uKGluZGV4OiBudW1iZXIsIHNhdmVQcmV2aW91czogYm9vbGVhbiA9IGZhbHNlLCByZWN1cnNpdmU6IGJvb2xlYW4gPSBmYWxzZSk6IHZvaWQge1xyXG4gICAgICAgIGlmIChpbmRleCA8IDAgfHwgdGhpcy5pdGVtc1NvdXJjZS5sZW5ndGggPD0gaW5kZXgpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCB0dXBsZSA9IHRoaXMuZ2V0U2VsZWN0aW9uVHVwbGUoaW5kZXgpO1xyXG4gICAgICAgIGlmICh0aGlzLmlzSW5kZXhTZWxlY3RlZChpbmRleCkpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuc2VsZWN0aW9uc0xpc3QubGVuZ3RoID09PSAxIHx8ICh0aGlzLnNlbGVjdGlvbnNMaXN0Lmxlbmd0aCA+IDEgJiYgc2F2ZVByZXZpb3VzKSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5kZXNlbGVjdEl0ZW0odHVwbGUsIHJlY3Vyc2l2ZSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdEl0ZW0odHVwbGUsIHNhdmVQcmV2aW91cywgcmVjdXJzaXZlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuc2VsZWN0SXRlbSh0dXBsZSwgc2F2ZVByZXZpb3VzLCByZWN1cnNpdmUpO1xyXG4gICAgfVxyXG4gICAgZ2V0U2VsZWN0aW9ucyhyZWN1cnNpdmU6IGJvb2xlYW4gPSBmYWxzZSk6IEFycmF5PE9iamVjdD4ge1xyXG4gICAgICAgIGlmIChyZWN1cnNpdmUpIHtcclxuICAgICAgICAgICAgbGV0IHJlc3VsdCA9IFtdO1xyXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuc2VsZWN0aW9uc0xpc3QubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGl0ZW0gPSB0aGlzLnNlbGVjdGlvbnNMaXN0W2ldLml0ZW07XHJcbiAgICAgICAgICAgICAgICByZXN1bHQucHVzaChpdGVtKTtcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhblJlY3Vyc2UocmVjdXJzaXZlLCBpdGVtKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IHJlc3VsdC5jb25jYXQoKChpdGVtIGFzIGFueSkpLnNlbGVjdGlvbk1hbmFnZXIuZ2V0U2VsZWN0aW9ucyh0cnVlKSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuc2VsZWN0aW9uc0xpc3QubWFwKChzZWxlY3RhYmxlKSA9PiBzZWxlY3RhYmxlLml0ZW0pO1xyXG4gICAgfVxyXG59XHJcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
